class Message{sender;receiver;x;y;dx;dy;status;life;constructor(e,t){this.sender=e,this.receiver=t,this.x=e.x,this.y=e.y,this.dx=0,this.dy=0,this.sender=e,this.receiver=t,this.status="req",this.life=0,this.computeVelocity()}computeVelocity(){var e=this.receiver.x-this.x,t=this.receiver.y-this.y,t=Math.atan2(t,e),e=Defaults.messageVelocity/Defaults.frameRate;this.dx=Math.cos(t)*e,this.dy=Math.sin(t)*e}move(){this.x+=this.dx,this.y+=this.dy}invertDirection(){var e=this.sender;this.sender=this.receiver,this.receiver=e,this.computeVelocity()}}class MessageOrchestrator{messages=[];totalACKs=0;avgResponseTime=0;createMessage(e,t){e=new Message(e,t);e.computeVelocity(),this.messages.push(e)}registerAck(e){this.totalACKs+=1,this.avgResponseTime=(e.life+(this.totalACKs-1)*this.avgResponseTime)/this.totalACKs}reset(){this.messages=[],this.totalACKs=0,this.avgResponseTime=0}updateMessages(){var t=Defaults.clientSize;for(let e=0;e<this.messages.length;e+=1){var s,a=this.messages[e];a.life+=1/Defaults.frameRate,"req"===a.status&&void 0===a.sender.connectedTo?this.messages.splice(e--,1):("ack"===a.status||"nack"===a.status)&&void 0===a.receiver.connectedTo||"done"===a.status?this.messages.splice(e--,1):"queued"!=a.status&&(s=a.receiver,a.x<s.x+t/2&&a.x>s.x-t/2&&a.y<s.y+t/2&&a.y>s.y-t/2?s.receiveMessage(a):a.move())}}}class Attacker{orchestrator;x;y;messages;connectedTo;lastMessageTime;messagesToSend;messagesToReceive;constructor(e,t,s,a,i){this.orchestrator=e,this.x=t,this.y=s,this.messages=a,this.connectedTo=i,this.x=t,this.y=s,this.connectedTo=i,this.lastMessageTime=0,this.messagesToSend=a,this.messagesToReceive=a}sendMessage(e){this.orchestrator.createMessage(this,this.connectedTo),--this.messagesToSend,this.lastMessageTime=e}receiveMessage(e){e.status="done",--this.messagesToReceive}}class TextFader{context;queues;constructor(e){this.context=e,this.queues={permanent:[],temporary:[]}}draw(){for(let e=0;e<this.queues.temporary.length;e++){var t=this.queues.temporary[e];for(let e=0;e<t.activeTexts.length;e++){var s=t.activeTexts[e];this.drawText(s,t.x,t.y)}}for(let e=0;e<this.queues.permanent.length;e+=1){var a=this.queues.permanent[e];this.drawText(a,a.x??0,a.y??0)}}update(t){for(let e=0;e<this.queues.temporary.length;e++){var s=this.queues.temporary[e];for(let e=0;e<s.activeTexts.length;e++){var a=s.activeTexts[e];a.delta+=70*t,a.fadeIn?(a.alpha+=.02,1<=a.alpha&&(a.fadeIn=!1)):(a.alpha-=.02,a.alpha<=0&&s.activeTexts.splice(e--,1))}0<s.queuedTexts.length&&(0===s.activeTexts.length||s.activeTexts[s.activeTexts.length-1].delta>s.queuedTexts[0].fontSize)&&s.activeTexts.push(s.queuedTexts.shift())}for(let e=0;e<this.queues.permanent.length;e+=1){var i=this.queues.permanent[e];i.fadeIn?(i.alpha+=.05,1<=i.alpha&&(i.fadeIn=!1)):(i.alpha-=.05,i.alpha<=0&&(i.fadeIn=!0))}}addText(e,t){e.life||(e.life=1e3),e.alpha=e.fadeIn?0:1,e.delta=0,e.font=e.fontWeight+" "+e.fontSize+"px Arial",this.queues.temporary.find(e=>e.id==t)?.queuedTexts.push(e)}addPermanentText(t){for(let e=0;e<this.queues.permanent.length;e++)if(this.queues.permanent[e].id===t.id)return;t.life||(t.life=1e3),t.alpha=0,t.fadeIn=!0,this.queues.permanent.push(t)}removeFromPermanentQueue(t){for(let e=0;e<this.queues.permanent.length;e++)if(this.queues.permanent[e].id===t)return void this.queues.permanent.splice(e,1)}createQueue(e,t,s){this.queues.temporary.push({id:e,x:t,y:s,activeTexts:[],queuedTexts:[]})}emptyQueues(){this.queues={permanent:[],temporary:[]}}drawText(e,t,s){var a=e.delta??0,{r:i,g:r,b:o}=e.color,i=`rgba(${i}, ${r}, ${o}, ${e.alpha})`;Utilities.drawText({x:t,y:s-a,text:e.text,font:e.font,align:"center",color:i},this.context)}}class Utilities{static drawCircle(e,t){t.beginPath(),t.arc(e.x,e.y,e.radius,0,2*Math.PI,!0),t.closePath(),Utilities.draw(e,t)}static drawCircleHighlight(e,t,s,a){e={x:e,y:t,radius:s,borderColor:"fireBrick",borderWidth:2},t={...e,radius:s+1,borderColor:"red"};Utilities.drawCircle(e,a),Utilities.drawCircle(t,a)}static drawLine(e,t,s,a,i,r,o){r=r||1,o.strokeStyle=i,o.lineWidth=r,o.beginPath(),o.moveTo(e,t),o.lineTo(s,a),o.stroke()}static drawRect(e,t){var s=e.x,a=e.y,i=e.width,r=e.height;t.beginPath(),t.rect(s-i/2,a-r/2,i,r),t.closePath(),Utilities.draw(e,t)}static drawStar(e,t){var s=e.x,a=e.y,i=e.spikes??5,r=e.outerRadius,o=e.innerRadius,h=Math.PI/i;let n,c,l=Math.PI/2*3;t.beginPath(),t.moveTo(s,a-r);for(let e=0;e<i;e+=1)n=s+Math.cos(l)*r,c=a+Math.sin(l)*r,t.lineTo(n,c),l+=h,n=s+Math.cos(l)*o,c=a+Math.sin(l)*o,t.lineTo(n,c),l+=h;t.lineTo(s,a-r),t.closePath(),Utilities.draw(e,t)}static drawText(e,t){t.font=e.font,t.textAlign=e.align??"start",t.textBaseline=e.baseline??"middle",t.fillStyle=e.color??Defaults.defaultColor,t.fillText(e.text,e.x,e.y)}static drawTriangle(e,t){var s=e.x,a=e.y,i=e.base,r=e.height;t.beginPath(),t.moveTo(s,a-r/2),t.lineTo(s+i/2,a+r/2),t.lineTo(s-i/2,a+r/2),Utilities.draw(e,t)}static getDistance(e,t,s,a){a-=t;return Math.sqrt(Math.pow(s-e,2)+Math.pow(a,2))}static invertColor(e){e=e.substring(1);var t=parseInt(e,16);return e="#"+(e=("000000"+(e=(t^=16777215).toString(16))).slice(-6))}static draw(e,t){e.color&&(t.fillStyle=e.color,t.fill()),e.borderColor&&(t.strokeStyle=e.borderColor,t.lineWidth=e.borderWidth??1,t.stroke())}}class UpgradesTracker{upgrades=[100,200,300,500,700,1e3,1300,1700,2100,2600,3100,3700,4300,5e3];nextUpgradeIndex=0;upgradesAvailable=0;selectedUpgrade;get nextUpgrade(){return this.nextUpgradeIndex>=this.upgrades.length?1/0:this.upgrades[this.nextUpgradeIndex]}increaseUpgrades(){this.upgradesAvailable+=1,this.nextUpgradeIndex+=1}reset(){this.nextUpgradeIndex=0,this.upgradesAvailable=0,this.selectedUpgrade=void 0}}class PopularityTracker{fader;upgrades;canvas;popularity;constructor(e,t,s){this.fader=e,this.upgrades=t,this.canvas=s,this.popularity=0}draw(e){var t=this.canvas.getContext("2d");Utilities.drawText({x:10,y:e,text:"Popularity: "+this.popularity,font:"18px sans-serif"},t)}reset(){this.popularity=0}updatePopularity(e,t,s){let a=12,i={r:0,g:150,b:0},r={r:150,g:250,b:150},o=1;e<0&&(i={r:150,g:0,b:0},r={r:250,g:150,b:150}),5<=Math.abs(e)&&(a=16,o=2);var h={text:e.toString(),color:i,fontSize:a,fontWeight:"bold",border:!0,borderColor:r,borderWidth:o,alpha:1,font:"",delta:0};this.fader.addText(h,t.toString()+s.toString()),this.popularity+=e,this.popularity>=this.upgrades.nextUpgrade&&this.upgrades.increaseUpgrades()}}class Client{orchestrator;popularity;x;y;messages;life;connectedTo;lastMessageTime;messagesToSend;ACKsToReceive;NACKsToDie;constructor(e,t,s,a,i){this.orchestrator=e,this.popularity=t,this.x=s,this.y=a,this.messages=i,this.x=s,this.y=a,this.life=0,this.lastMessageTime=0,this.messagesToSend=i,this.ACKsToReceive=i,this.NACKsToDie=Math.floor(i/3)}sendMessage(e){if(!this.connectedTo)throw"Disconnected client cannot send messages.";this.orchestrator.createMessage(this,this.connectedTo),--this.messagesToSend,this.lastMessageTime=e}receiveMessage(e){let t;"ack"===e.status?(--this.ACKsToReceive,t=1,0===this.ACKsToReceive&&(t+=5),this.orchestrator.registerAck(e)):(--this.NACKsToDie,t=-1,0<this.NACKsToDie?this.messagesToSend+=1:t-=5),this.popularity.updatePopularity(t,this.x,this.y),e.status="done"}}class Server{x;y;queue;lastMessageTime;capacity;speed;constructor(e,t){this.x=e,this.y=t,this.x=e,this.y=t,this.queue=[],this.lastMessageTime=0,this.capacity=Defaults.serversCapacity,this.speed=Defaults.serversSpeed}sendMessage(e){var t=this.queue.shift();t&&(t.status="ack",t.invertDirection(),this.lastMessageTime=e)}receiveMessage(e){e.x=this.x,e.y=this.y,this.queue.length<this.capacity?(this.queue.push(e),e.status="queued"):(e.status="nack",e.invertDirection())}}class Button{x;y;width;height;text;color;onClick;constructor(e,t,s,a,i,r,o){this.x=e,this.y=t,this.width=s,this.height=a,this.text=i,this.color=r,this.onClick=o}draw(e,t){var s=e?Utilities.invertColor(this.color):this.color;Utilities.drawRect({x:this.x,y:this.y,width:this.width,height:this.height,color:e?this.color:void 0,borderColor:this.color,borderWidth:2},t),Utilities.drawText({x:this.x,y:this.y,text:this.text,font:"15px monospace",align:"center",color:s},t)}}class GameUI{buttons=[];volumeButton;constructor(i,e){let r=e.getContext("2d"),t=e.width,s=e.height,o=t-40,h=s-40;this.volumeButton=new SpecialButton(o,h,20,20,"rgba(0,0,0,0)","rgba(0,0,0,0)",0,()=>{i.paused?i.play():i.pause()},e=>{var t=e?"white":"rgba(255,255,255,0.8)",s=i.paused?"Off":"On",a=(Utilities.drawRect({x:o-5+1,y:h,width:6,height:9,color:t},r),new Path2D);a.moveTo(o-1,h-5),a.lineTo(5+o,h-10+1),a.lineTo(5+o,10+h-1),a.lineTo(o-1,5+h),a.closePath(),r.fillStyle=t,r.fill(a),i.paused&&(Utilities.drawLine(o-10,10+h,10+o,h-10,"red",2,r),s="Off"),e&&Utilities.drawText({x:o,y:10+h+2,text:"Music: "+s,font:"10px monospace",align:"center",baseline:"top",color:"#fff"},r)})}click(t,s){this.buttons.some(e=>{if(t>e.x-e.width/2&&t<e.x+e.width/2&&s>e.y-e.height/2&&s<e.y+e.height/2)return e.onClick(),!0})}}class GameTracker{popularityTracker;ui;selectedClient;currentGameMode=0;clientsServed=0;droppedConnections=0;failedConnections=0;elapsedTime=0;servers=[];clients=[];attackers=[];constructor(e,t){this.popularityTracker=e,this.ui=t}switchMode(e){this.ui.buttons=[],this.currentGameMode=e}reset(){this.selectedClient=void 0,this.clientsServed=0,this.droppedConnections=0,this.failedConnections=0,this.elapsedTime=0,this.servers=[],this.clients=[],this.attackers=[],this.switchMode(Defaults.gameModes.GAME)}update(){this.elapsedTime+=1/Defaults.frameRate,this.updateClients(),this.updateServers(),this.updateAttackers()}updateServers(){let t=this.elapsedTime;this.servers.forEach(function(e){t-e.lastMessageTime>1/e.speed&&e.sendMessage(t)})}updateClients(){var t=this.elapsedTime,s=60*Defaults.gameLength-t;for(let e=0;e<this.clients.length;e++){var a=this.clients[e];s<=0&&0<a.messagesToSend&&(a.ACKsToReceive-=a.messagesToSend,a.messagesToSend=0),0===a.messagesToSend&&0===a.ACKsToReceive?(this.clients.splice(e--,1),this.clientsServed+=1):0===a.NACKsToDie?(a.connectedTo=void 0,this.clients.splice(e--,1),this.droppedConnections+=1):void 0===a.connectedTo?(a.life+=1/Defaults.frameRate,(s<=0||a.life>Defaults.maxClientWaitTime)&&(this.clients.splice(e--,1),a===this.selectedClient&&(this.selectedClient=void 0),this.failedConnections+=1,this.popularityTracker.updatePopularity(-10,a.x,a.y))):0<a.messagesToSend&&t-a.lastMessageTime>1/Defaults.clientsSpeed&&a.sendMessage(t)}}updateAttackers(){var t=this.elapsedTime;for(let e=0;e<this.attackers.length;e+=1){var s=this.attackers[e];0===s.messagesToReceive?this.attackers.splice(e--,1):0!=s.messagesToSend&&t-s.lastMessageTime>.5/Defaults.clientsSpeed&&s.sendMessage(t)}}}class Scheduler{popularityTracker;fader;orchestrator;canvas;game;timeLastDDoS=0;minClientMessages=25;maxClientMessages=35;attackersMessages=30;attackersNumber=1;spawnRate=6;attackRate=80;timeLastClient=1-this.spawnRate;constructor(e,t,s,a,i){this.popularityTracker=e,this.fader=t,this.orchestrator=s,this.canvas=a,this.game=i}schedule(){var e=this.popularityTracker.popularity,t=this.game.elapsedTime,s=60*Defaults.gameLength-t;s>Defaults.maxClientWaitTime&&t-this.timeLastClient>Math.max(this.spawnRate-Math.cbrt(e/40),1.6)&&.3<Math.random()&&this.createClient(),30<s&&t-this.timeLastDDoS>Math.max(this.attackRate-e/100,60)&&.3<Math.random()&&this.initiateDDoS()}reset(){this.timeLastDDoS=0,this.timeLastClient=1-this.spawnRate}createServer(e){var t=this.canvas.width,s=this.canvas.height,a=Defaults.serverSize;let i,r,o,h,n,c;switch(e){case"nw":o=a,h=a,n=t/3,c=s/3;break;case"n":o=t/3,h=a,n=2*t/3,c=s/3;break;case"ne":o=2*t/3,h=a,n=t-a,c=s/3;break;case"w":o=a,h=s/3,n=t/3,c=2*s/3;break;case"c":o=t/3,h=s/3,n=2*t/3,c=2*s/3;break;case"e":o=2*t/3,h=s/3,n=t-a,c=2*s/3;break;case"sw":o=a,h=2*s/3,n=t/3,c=s-a;break;case"s":o=t/3,h=2*s/3,n=2*t/3,c=s-a;break;case"se":o=2*t/3,h=2*s/3,n=t-a,c=s-a;break;default:throw`Invalid zone: ${e}.`}for(i=Math.floor(Math.random()*(n-o)+o),r=Math.floor(Math.random()*(c-h)+h);this.checkCollisions(i,r);)i=Math.floor(Math.random()*(n-o)+o),r=Math.floor(Math.random()*(c-h)+h);this.game.servers.push(new Server(i,r))}createClient(){var e=this.canvas.width,t=this.canvas.height,s=this.game.elapsedTime,a=Defaults.clientSize;let i,r,o;for(i=Math.floor(Math.random()*(e-2*a)+a),r=Math.floor(Math.random()*(t-2*a)+a);this.checkCollisions(i,r);)i=Math.floor(Math.random()*(e-2*a)+a),r=Math.floor(Math.random()*(t-2*a)+a);o=Math.floor(Math.random()*(this.maxClientMessages-this.minClientMessages))+this.minClientMessages+Math.floor(this.popularityTracker.popularity/100),this.game.clients.push(new Client(this.orchestrator,this.popularityTracker,i,r,o)),this.fader.createQueue(i.toString()+r.toString(),i,r-8-a/2),this.timeLastClient=s}initiateDDoS(){for(var e,t,s=this.canvas.width,a=this.canvas.height,i=this.game.elapsedTime,r=Defaults.clientSize,o=Math.floor(this.popularityTracker.popularity/400),h=this.attackersNumber+o,n=0;n<h;n+=1){for(e=Math.floor(Math.random()*(s-2*r)+r),t=Math.floor(Math.random()*(a-2*r)+r);this.checkCollisions(e,t);)e=Math.floor(Math.random()*(s-2*r)+r),t=Math.floor(Math.random()*(a-2*r)+r);var c=this.findClosestServer(e,t);c&&(c=new Attacker(this.orchestrator,e,t,this.attackersMessages+o,c),this.game.attackers.push(c))}this.timeLastDDoS=i}checkCollisions(t,s){var a=Defaults.serverSize,i=Defaults.clientSize,r=this.game.servers,o=this.game.clients,h=this.game.attackers;for(let e=0;e<r.length;e+=1){var n=r[e];if(Math.abs(t-n.x)<a&&Math.abs(s-n.y)<2*a)return!0}for(let e=0;e<o.length;e+=1){var c=o[e];if(Math.abs(t-c.x)<i&&Math.abs(s-c.y)<i)return!0}for(let e=0;e<h.length;e+=1){var l=h[e];if(Math.abs(t-l.x)<i&&Math.abs(s-l.y)<i)return!0}}findClosestServer(s,a){let i,r=this.canvas.width;return this.game.servers.forEach(e=>{var t=Utilities.getDistance(s,a,e.x,e.y);t<r&&(r=t,i=e)}),i}}class NewGame{orchestrator;upgrades;popularity;game;scheduler;fader;constructor(e,t,s,a,i,r){this.orchestrator=e,this.upgrades=t,this.popularity=s,this.game=a,this.scheduler=i,this.fader=r}execute(){this.orchestrator.reset(),this.upgrades.reset(),this.popularity.reset(),this.game.reset(),this.scheduler.reset(),this.fader.emptyQueues()}}class Credits{canvas;clouds;buttons;id=Defaults.gameModes.CREDITS;constructor(e,t,s){this.canvas=e,this.clouds=t;t=e.width,e=e.height;this.buttons=[new Button(t/2,e-60,120,40,"Back","#FFFFFF",()=>{s.switchMode(Defaults.gameModes.MENU)})]}getButtons(){return this.buttons}update(){this.clouds.draw(),this.drawCredits(128,"An idea by:","Treestle","(treestle.com)"),this.drawCredits(258,"Designed and developed by:","Naccio","(naccio.net)"),this.drawCredits(388,"Music by:","Macspider","(soundcloud.com/macspider)")}drawCredits(e,t,s,a){this.drawRect(e),this.drawHeading(e-28,t),this.drawMainText(e,s),this.drawSubText(e+28,a)}drawRect(e){var t=this.canvas.getContext("2d"),s=this.canvas.width;Utilities.drawRect({x:s/2,y:e,width:this.canvas.width,height:100,color:"rgba(0,0,0,0.1)",borderColor:"rgba(200,200,200,0.5)"},t)}drawHeading(e,t){this.drawText(e,t,"bold 20px monospace","red")}drawMainText(e,t){this.drawText(e,t,"30px monospace","white")}drawSubText(e,t){this.drawText(e,t,"15px monospace","#ddd")}drawText(e,t,s,a){var i=this.canvas.getContext("2d"),r=this.canvas.width;Utilities.drawText({x:r/2,y:e,text:t,font:s,align:"center",color:a},i)}}class Defaults{static clientSize=30;static clientsSpeed=2;static defaultColor="black";static frameRate=60;static gameLength=5;static maxClientWaitTime=9;static messageSize=6;static messageVelocity=200;static serversCapacity=80;static serverSize=40;static serversSpeed=3.5;static gameModes={MENU:0,GAME:1,GAME_OVER:2,CREDITS:3,PAUSE:4,UPGRADE:5,TUTORIAL:6}}class CursorTracker{game;canvas;ui;mouseX=0;mouseY=0;constructor(e,t,s){this.game=e,this.canvas=t,this.ui=s}bind(){this.canvas.onmousedown=e=>this.mouseDownHandler(e),this.canvas.onmouseup=e=>this.mouseUpHandler(e),this.canvas.onclick=e=>this.clickHandler(e),this.canvas.onmousemove=e=>{this.mouseX=e.clientX-this.canvas.offsetLeft,this.mouseY=e.clientY-this.canvas.offsetTop},this.canvas.ontouchstart=e=>this.touchHandler(e),this.canvas.ontouchmove=e=>this.touchHandler(e),this.canvas.ontouchend=e=>this.touchHandler(e),this.canvas.ontouchcancel=e=>this.touchHandler(e)}clickHandler(e){var t=this.canvas,s=e.pageX-t.offsetLeft;this.ui.click(s,e.pageY-t.offsetTop)}cursorPositionHandler(t,s){let a=this.game,e=Defaults.gameModes,i=Defaults.clientSize,r=Defaults.serverSize;a.currentGameMode!=e.GAME&&a.currentGameMode!=e.TUTORIAL||(void 0!==a.selectedClient&&a.servers.forEach(function(e){t>e.x-r/2-5&&t<e.x+r/2+5&&s>e.y-r/2-5&&s<e.y+r/2+5&&(a.selectedClient.connectedTo=e)}),a.selectedClient=void 0,a.clients.forEach(e=>{t>e.x-i/2-5&&t<e.x+i/2+5&&s>e.y-r/2-5&&s<e.y+r/2+5&&void 0===e.connectedTo&&(a.selectedClient=e,this.mouseX=e.x,this.mouseY=e.y)}))}mouseDownHandler(e){var t=this.canvas,s=e.pageX-t.offsetLeft;this.cursorPositionHandler(s,e.pageY-t.offsetTop)}mouseUpHandler(e){let a=this.game,i=this.canvas,t=Defaults.gameModes,r=Defaults.serverSize;if(a.currentGameMode==t.GAME||a.currentGameMode==t.TUTORIAL){let t=e.pageX-i.offsetLeft,s=e.pageY-i.offsetTop;void 0!==a.selectedClient&&a.servers.forEach(function(e){t>e.x-r/2-5&&t<e.x+r/2+5&&s>e.y-r/2-5&&s<e.y+r/2+5&&(a.selectedClient.connectedTo=e,a.selectedClient=void 0)})}}touchHandler(e){let i=this.game,t=this.canvas,s=e.targetTouches[0],a=s.pageX-t.offsetLeft,r=s.pageY-t.offsetTop;if(e.preventDefault(),"touchstart"==e.type)this.mouseX=a,this.mouseY=r,this.ui.click(a,r),this.cursorPositionHandler(a,r);else if("touchmove"==e.type)this.mouseX=a,this.mouseY=r;else if("touchend"==e.type&&void 0!==i.selectedClient){let t=this.mouseX,s=this.mouseY,a=Defaults.serverSize,e=Defaults.clientSize;i.servers.forEach(function(e){t>e.x-a/2-5&&t<e.x+a/2+5&&s>e.y-a/2-5&&s<e.y+a/2+5&&(i.selectedClient.connectedTo=e)}),(t<i.selectedClient.x-e/2-5||t>i.selectedClient.x+e/2+5||s<i.selectedClient.y-e/2-5||s>i.selectedClient.y+e/2+5)&&(i.selectedClient=void 0)}}}class GameArea{canvas;game;orchestrator;popularityTracker;upgradesTracker;cursor;fader;constructor(e,t,s,a,i,r,o){this.canvas=e,this.game=t,this.orchestrator=s,this.popularityTracker=a,this.upgradesTracker=i,this.cursor=r,this.fader=o}draw(){var e=this.canvas.getContext("2d"),t=this.game.selectedClient;void 0!==t&&(Utilities.drawLine(t.x,t.y,this.cursor.mouseX,this.cursor.mouseY,"lightBlue",3,e),Utilities.drawCircle({x:t.x,y:t.y,radius:Defaults.clientSize/2+3,color:"lightBlue"},e)),this.drawConnections(),this.drawMessages(),this.drawClients(),this.drawAttackers(),this.drawServers(),this.drawUI()}drawAttackers(){this.game.attackers.forEach(e=>this.drawAttacker(e))}drawClients(){this.game.clients.forEach(e=>this.drawClient(e))}drawConnections(){this.game.clients.forEach(e=>this.drawConnection(e,"darkGray")),this.game.attackers.forEach(e=>this.drawConnection(e,"dimGray"))}drawMessages(){this.orchestrator.messages.forEach(e=>this.drawMessage(e))}drawServers(){this.game.servers.forEach(e=>this.drawServer(e))}drawUI(){var e=this.canvas.getContext("2d"),t=this.canvas.width,s=this.canvas.height;if(this.fader.draw(),this.popularityTracker.draw(s-14),Utilities.drawText({x:t/2,y:s-14,text:"Press space to pause",font:"18px sans-serif",align:"center",baseline:"alphabetic",color:"darkGray"},e),0<this.upgradesTracker.upgradesAvailable){let e={x:t/2,y:s-35,fontSize:20,fontWeight:"",font:"20px sans-serif",color:{r:255,g:0,b:0},id:"upgrade",text:"- Upgrade available! -",life:400,alpha:0,delta:0};this.fader.addPermanentText(e)}var a=Math.max(0,60*Defaults.gameLength-this.game.elapsedTime),i=Math.floor(a/60),r=Math.floor(a-60*i);let o="",h=(i<10&&(o+="0"),o+=i+":",r<10&&(o+="0"),o+=r,"darkGray");a<=30&&(h="tomato"),a<=10&&(h="red"),Utilities.drawText({x:t-10,y:s-14,text:o,font:"18px sans-serif",align:"end",baseline:"alphabetic",color:h},e)}drawAttacker(e){var t=this.canvas.getContext("2d"),s=Defaults.clientSize,a=e.x,e=e.y;Utilities.drawTriangle({x:a,y:e,base:2*s/Math.sqrt(3),height:s,color:"#333333",borderColor:"black",borderWidth:2},t),Utilities.drawText({x:a,y:e+8,text:"DoS",font:"bold 9px Arial",align:"center",color:"white"},t)}drawClient(e){var t=this.canvas.getContext("2d"),s=Defaults.clientSize,a=Defaults.maxClientWaitTime,i=e.x,r=e.y,s={x:i,y:r,radius:s/2,color:"gray",borderColor:"dimGray"};void 0===e.connectedTo?(void 0===e.connectedTo&&e.life>a-2?Utilities.drawCircle({...s,color:"red",borderColor:"fireBrick"},t):void 0===e.connectedTo&&e.life>a-3.5?Utilities.drawCircle({...s,color:"tomato",borderColor:"indianRed"},t):Utilities.drawCircle(s,t),Utilities.drawText({x:i,y:r,text:Math.round(a-e.life).toString(),font:"bold 15px Arial",align:"center",color:"white"},t)):Utilities.drawCircle(s,t)}drawConnection(e,t){var s;e.connectedTo&&(s=this.canvas.getContext("2d"),Utilities.drawLine(e.x,e.y,e.connectedTo.x,e.connectedTo.y,t,1,s))}drawMessage(e){var t=this.canvas.getContext("2d");let s,a;switch(e.status){case"queued":case"done":return;case"req":s="lightBlue",a="steelBlue";break;case"ack":s="lime",a="limeGreen";break;case"nack":s="tomato",a="indianRed";break;default:throw"Invalid message status: "+e.status}Utilities.drawCircle({x:e.x,y:e.y,radius:Defaults.messageSize/2,color:s,borderColor:a},t)}drawServer(e){var t=this.canvas.getContext("2d"),s=Defaults.serverSize;let a=Math.max(0,e.capacity/Defaults.serversCapacity-1);for(;-1<a;--a){var i=`rgb(0,${128-15*a},0)`,r=`rgb(0,${100-15*a},0)`;Utilities.drawRect({x:e.x+3*a,y:e.y-3*a,width:s,height:s,color:i,borderColor:r},t)}var o=Defaults.serversSpeed,h=s-10,n=e.x+s/2-7,c=e.y+1,l=e.queue.length/e.capacity*100*h/100,d=n,u=c+h/2-l/2,n=(Utilities.drawRect({x:n,y:c,width:7,height:2+h,borderColor:"#004500"},t),t.createLinearGradient(d,c+h/2,d,c-h/2));for(n.addColorStop(.5,"limeGreen"),n.addColorStop(1,"red"),Utilities.drawRect({x:d,y:u,width:5,height:l,color:n},t),a=e.speed;0<a;a-=o){var p=e.x-s/2+7,g=e.y+s/2-4-a/o*5;Utilities.drawStar({x:p,y:g,outerRadius:4,innerRadius:2,color:"limeGreen",borderColor:"#004500"},t)}}}class Game{canvas;game;scheduler;orchestrator;gameArea;fader;id=Defaults.gameModes.GAME;constructor(e,t,s,a,i,r){this.canvas=e,this.game=t,this.scheduler=s,this.orchestrator=a,this.gameArea=i,this.fader=r}getButtons(){return[]}update(){var e,t,s;0===this.game.servers.length&&this.scheduler.createServer("c"),this.orchestrator.updateMessages(),this.game.update(),this.fader.update(1/Defaults.frameRate),this.scheduler.schedule(),Math.floor(this.game.elapsedTime/60)===Defaults.gameLength&&0===this.game.clients.length?this.game.switchMode(Defaults.gameModes.GAME_OVER):(e=this.canvas.getContext("2d"),t=this.canvas.width,s=this.canvas.height,e.clearRect(0,0,t,s),this.gameArea.draw())}}class GameOver{canvas;clouds;game;orchestrator;popularity;color="white";buttons;id=Defaults.gameModes.GAME_OVER;constructor(e,t,s,a,i,r){this.canvas=e,this.clouds=t,this.game=s,this.orchestrator=a,this.popularity=i;t=e.width,a=e.height;this.buttons=[new Button(t/2,a-110,120,40,"Restart","#FFFFFF",()=>r.execute()),new Button(t/2,a-60,120,40,"Menu","#FFFFFF",()=>s.switchMode(Defaults.gameModes.MENU))]}getButtons(){return this.buttons}update(){var e=this.canvas.getContext("2d"),t=this.canvas.width,s=this.canvas.height,a=(this.clouds.draw(),Utilities.drawText({x:t/2,y:100,text:"Game Over",font:"small-caps 60px monospace",align:"center",color:"red"},e),this.drawStat(s/2-80,"Successful connections",this.game.clientsServed),this.drawStat(s/2-55,"Dropped connections",this.game.droppedConnections),this.drawStat(s/2-30,"Failed connections",this.game.failedConnections),this.drawStat(s/2-5,"Average response time",Math.round(100*this.orchestrator.avgResponseTime)/100),"30px monospace");Utilities.drawText({x:t/2+68,y:s/2+50,text:"Popularity:",font:a,align:"end",color:this.color},e),Utilities.drawText({x:t/2+75,y:s/2+50,text:this.popularity.popularity.toString(),font:a,align:"start",color:this.color},e),Utilities.drawLine(t/2-130,s/2+20,t/2+130,s/2+20,"red",1,e)}drawStat(e,t,s){this.drawStatTitle(e,t),this.drawStatValue(e,s)}drawStatTitle(e,t){var s=this.canvas.getContext("2d"),a=this.canvas.width/2+80;Utilities.drawText({x:a,y:e,text:t+":",font:"15px monospace",align:"end",color:this.color},s)}drawStatValue(e,t){var s=this.canvas.getContext("2d"),a=this.canvas.width/2+90;Utilities.drawText({x:a,y:e,text:t.toString(),font:"15px monospace",align:"start",color:this.color},s)}}class TutorialStep{id;texts;hasNext=!1;hasHome=!1;advance=!1;advanceOnSpace=!1;extraButtons=[];constructor(e,t){this.id=e,this.texts=t}setup(){}run(){}draw(){}}class Tutorial{steps;canvas;gameArea;fader;game;orchestrator;nextButton;homeButton;currentStep;id=Defaults.gameModes.TUTORIAL;constructor(e,t,s,a,i,r){this.steps=e,this.canvas=t,this.gameArea=s,this.fader=a,this.game=i,this.orchestrator=r;s=t.width,a=t.height;this.currentStep=e[0],this.nextButton=new Button(s/3,a-40,120,40,"Next","#FFFFFF",()=>this.advance()),this.homeButton=new Button(2*s/3,a-40,120,40,"Exit tutorial","#FFFFFF",()=>i.switchMode(Defaults.gameModes.MENU)),this.currentStep.setup(),document.addEventListener("keypress",e=>this.listener(e))}getButtons(){var e=[...this.currentStep.extraButtons];return this.currentStep.hasNext&&e.push(this.nextButton),this.currentStep.hasHome&&e.push(this.homeButton),e}update(){var t=this.canvas.getContext("2d"),s=this.canvas.width,e=this.canvas.height,a=this.currentStep.texts,i={x:s/2,y:0,width:s,height:80,color:"#0360AE",borderColor:"#02467F"};this.currentStep.run(),this.fader.update(1/Defaults.frameRate),this.currentStep.advance&&this.advance(),t.clearRect(0,0,s,e),this.gameArea.draw(),this.fader.draw(),Utilities.drawRect({...i,y:40},t);for(let e=0;e<a.length;e++){var r=a[e];Utilities.drawText({x:s/2,y:18+20*e,text:r,font:"bold 18px monospace",align:"center",color:"white"},t)}Utilities.drawRect({...i,y:e-40},t),this.currentStep.draw()}reset(){this.game.reset(),this.orchestrator.reset(),this.fader.emptyQueues(),this.currentStep=this.steps[0],this.currentStep.setup(),this.game.switchMode(Defaults.gameModes.TUTORIAL)}advance(){this.currentStep=this.steps[this.currentStep.id+1],this.currentStep.setup()}listener(e){" "===e.key&&this.currentStep.advanceOnSpace&&this.advance()}}class Menu{canvas;clouds;buttons;id=Defaults.gameModes.MENU;constructor(e,t,s,a,i,r){this.canvas=e,this.clouds=t;t=e.width,e=e.height;this.buttons=[new Button(t/2,e/2,120,40,"Tutorial","#FFFFFF",()=>i.reset()),new Button(t/2,e/2+60,120,40,"New Game","#FFFFFF",()=>r.execute()),new Button(t/2,e/2+120,120,40,"Credits","#FFFFFF",()=>s.switchMode(Defaults.gameModes.CREDITS)),a.volumeButton]}getButtons(){return this.buttons}update(){var e=this.canvas.getContext("2d"),t=this.canvas.width,s="rgba(255,255,255,0.6)";this.clouds.draw(),Utilities.drawRect({x:t/2,y:140,width:t,height:180,color:"rgba(0,0,0,0.1)",borderColor:"rgba(200,200,200,0.5)"},e),Utilities.drawText({x:t/2,y:110,text:"Load Balancing",font:"small-caps bold 110px monospace",align:"center",color:s},e),Utilities.drawText({x:t/2,y:185,text:"The Game",font:"45px monospace",align:"center",color:s},e),Utilities.drawLine(120,160,t-118,160,"red",2,e)}}class SpecialButton extends Button{hoverColor;borderWidth;specialDraw;constructor(e,t,s,a,i,r,o,h,n){super(e,t,s,a,"",i,h),this.hoverColor=r,this.borderWidth=o,this.specialDraw=n}draw(e,t){Utilities.drawRect({x:this.x,y:this.y,width:this.width,height:this.height,color:this.color,borderColor:e?this.hoverColor:void 0},t),this.specialDraw(e)}}class Pause{canvas;clouds;game;upgradesTracker;buttons;upgradeButtons;id=Defaults.gameModes.PAUSE;constructor(e,t,s,a,i,r){this.canvas=e,this.clouds=t,this.game=s,this.upgradesTracker=a;let o=e.getContext("2d"),h=e.width,n=Defaults.serverSize;this.buttons=[new Button(h/2,150,120,40,"Continue","#FFFFFF",()=>s.switchMode(Defaults.gameModes.GAME)),new Button(h/2,210,120,40,"New game","#FFFFFF",()=>r.execute()),new Button(h/2,270,120,40,"Abandon","#FFFFFF",()=>s.switchMode(Defaults.gameModes.MENU)),i.volumeButton],this.upgradeButtons=[this.createUpgradeButton(250,"server","Buy new datacenter",(e,t)=>{Utilities.drawText({x:e-25,y:t,text:"+",font:"45px monospace",align:"center",color:"red"},o),Utilities.drawRect({x:e+15,y:t,width:n,height:n,color:"#DDDDDD",borderColor:"red"},o),Utilities.drawStar({x:e-n/2+22,y:t+n/2-9,outerRadius:4,innerRadius:2,color:"#BBBBBB",borderColor:"#999999"},o),Utilities.drawRect({x:e+n/2+8,y:t+1,width:6,height:n-10,color:"#BBBBBB",borderColor:"#999999"},o)}),this.createUpgradeButton(h/2,"capacity","Scale off at one location",(e,t)=>{var s=e+n/2-7,a=t+1,i=e-n/2+7,r=t+n/2-9;Utilities.drawRect({x:e,y:t,width:n,height:n,color:"#DDDDDD",borderColor:"#999999"},o),Utilities.drawRect({x:s,y:a,width:6,height:n-10,color:"salmon",borderColor:"red"},o),Utilities.drawStar({x:i,y:r,outerRadius:4,innerRadius:2,color:"#BBBBBB",borderColor:"#999999"},o),Utilities.drawLine(s,a-n/2+2,s,a-n/2-13,"red",3,o),Utilities.drawLine(s-1,a-n/2-13,5+s,a-n/2-6,"red",3,o),Utilities.drawLine(1+s,a-n/2-13,s-5,a-n/2-6,"red",3,o)}),this.createUpgradeButton(h-250,"speed","Improve speed at one location",(e,t)=>{var s=e+n/2-7,a=t+1,i=e-n/2+7,r=t+n/2-9;Utilities.drawRect({x:e,y:t,width:n,height:n,color:"#DDDDDD",borderColor:"#999999"},o),Utilities.drawRect({x:s,y:a,width:6,height:n-10,color:"#BBBBBB",borderColor:"#999999"},o),Utilities.drawStar({x:i,y:r,outerRadius:4,innerRadius:2,color:"salmon",borderColor:"red"},o),Utilities.drawLine(i,r-8,i,r-21,"red",3,o),Utilities.drawLine(i-1,r-21,5+i,r-14,"red",3,o),Utilities.drawLine(1+i,r-21,i-5,r-14,"red",3,o)})]}getButtons(){return 0<this.upgradesTracker.upgradesAvailable?[...this.buttons,...this.upgradeButtons]:[...this.buttons]}update(){var e,t=this.canvas.getContext("2d"),s=this.canvas.width,a=this.canvas.height,s=s/2,i="25px monospace";this.clouds.draw(),0<this.upgradesTracker.upgradesAvailable?(e="black",Utilities.drawText({x:s,y:a/2+60,text:"Choose an upgrade:",font:i,align:"center",color:e},t)):(e="#DDDDDD",Utilities.drawText({x:s,y:a/2+60,text:"No upgrades available",font:i,align:"center",color:e},t)),e="red",i="50px monospace",Utilities.drawText({x:s,y:60,text:"~ Paused ~",font:i,align:"center",color:e},t)}createUpgradeButton(t,e,s,a){let i=this.canvas.getContext("2d"),r=this.canvas.width,o=this.canvas.height,h=o/2+150;return new SpecialButton(t,h,100,100,"#333333","white",2,()=>{this.upgradesTracker.selectedUpgrade=e,this.game.switchMode(Defaults.gameModes.UPGRADE)},e=>{a(t,h),e&&Utilities.drawText({x:r/2,y:o-50,text:s,font:"20px monospace",align:"center",color:"red"},i)})}}class TutorialStep1 extends TutorialStep{canvas;game;constructor(e,t){super(0,["Welcome to Load Balancing: The Game!","Here you will take the role of -you guessed it- a LOAD BALANCER.",'Click "Next" to start the tutorial.']),this.canvas=e,this.game=t,this.hasNext=!0,this.hasHome=!0}setup(){var e=this.canvas.width,t=this.canvas.height,e=new Server(e/2,t/2);e.capacity=20,this.game.servers.push(e)}}class TutorialStep2 extends TutorialStep{canvas;constructor(e){super(1,["This is a DATACENTER.","Its role is to send data to your clients.",'Click "Next" to continue.']),this.canvas=e,this.hasNext=!0,this.hasHome=!0}draw(){var e=this.canvas.getContext("2d"),t=this.canvas.width,s=this.canvas.height;Utilities.drawCircleHighlight(t/2,s/2,Defaults.serverSize+9,e)}}class TutorialStep3 extends TutorialStep{canvas;game;orchestrator;popularityTracker;constructor(e,t,s,a){super(2,["This is a CLIENT.","It wants to exchange data with your datacenter.","Your job will be to connect the clients to a datacenter."]),this.canvas=e,this.game=t,this.orchestrator=s,this.popularityTracker=a,this.hasNext=!0,this.hasHome=!0}setup(){var e=this.canvas.width,t=this.canvas.height,e=new Client(this.orchestrator,this.popularityTracker,3*e/4,t/2,1e4);e.life=-31,this.game.clients.push(e)}draw(){var e=this.canvas.getContext("2d"),t=this.canvas.width,s=this.canvas.height;Utilities.drawCircleHighlight(3*t/4,s/2,Defaults.clientSize+9,e),Utilities.drawCircle({x:3*t/4,y:s/2,radius:Defaults.clientSize/2,color:"gray"},e)}}class TutorialStep4 extends TutorialStep{game;constructor(e){super(3,["To create a connection, click on the client and then on the datacenter.","Be quick though! Clients don't like waiting!","Create a CONNECTION to continue."]),this.game=e,this.hasHome=!0}run(){var e=this.game.clients[0];void 0!==e.connectedTo&&(this.advance=!0),e.life>=Defaults.maxClientWaitTime-1&&(this.texts=["Snap! You let too much time pass!","Normally this would be bad for you, but this time you'll get a little help.","Create a CONNECTION to continue."],e.life=-31),this.game.updateClients()}}class TutorialHelper{static drawLegend(e,t){var s=e.getContext("2d"),e=e.width-120,a={x:e,y:100,radius:3},e={x:2+e+3,y:100,text:"",font:"10px sans-serif"};Utilities.drawCircle({...a,color:"lightBlue",borderColor:"skyBlue"},s),Utilities.drawText({...e,text:": Request"},s),Utilities.drawCircle({...a,y:108,color:"lime",borderColor:"limeGreen"},s),Utilities.drawText({...e,y:108,text:": Response (+1)"},s),t&&(Utilities.drawCircle({...a,y:116,color:"tomato",borderColor:"indianRed"},s),Utilities.drawText({...e,y:116,text:": Datacenter busy (-1)"},s))}}class TutorialStep5 extends TutorialStep{canvas;game;orchestrator;popularityTracker;constructor(e,t,s,a){super(4,["Good job! Now your very first client is being served.","You can see the REQUESTS and RESPONSES traveling along the connection.","The POPULARITY measures how successful your service is being."]),this.canvas=e,this.game=t,this.orchestrator=s,this.popularityTracker=a,this.hasNext=!0,this.hasHome=!0}setup(){this.popularityTracker.popularity=0}run(){this.orchestrator.updateMessages(),this.game.update()}draw(){var e=this.canvas.getContext("2d"),t=this.canvas.height;this.popularityTracker.draw(t-95),TutorialHelper.drawLegend(this.canvas,!1),Utilities.drawCircleHighlight(70,t-95,67,e)}}class TutorialStep6 extends TutorialStep{canvas;game;orchestrator;popularityTracker;constructor(e,t,s,a){super(5,["Cool! Two new clients want to use your service!","Connect them as well to start gaining some more popularity.","Remember, if you wait too much, you will lose popularity!"]),this.canvas=e,this.game=t,this.orchestrator=s,this.popularityTracker=a,this.hasHome=!0}setup(){this.spawnClients()}run(){var e=this.game.servers[0];e.queue.length>e.capacity/2&&(this.advance=!0),1===this.game.clients.length&&(this.texts=["Oh snap! You let too much time pass!","As you can see you lost 10 popularity each.","Connect the two clients to continue."],this.spawnClients()),this.orchestrator.updateMessages(),this.game.update()}draw(){var e=this.canvas.height;this.popularityTracker.draw(e-95),TutorialHelper.drawLegend(this.canvas,!1)}spawnClients(){var e=this.canvas.width,t=this.canvas.height,s=new Client(this.orchestrator,this.popularityTracker,e/4,t/4,1e4),e=new Client(this.orchestrator,this.popularityTracker,e/4,3*t/4,1e4);s.life=-21,e.life=-21,this.game.clients.push(s,e)}}class TutorialStep7 extends TutorialStep{canvas;game;orchestrator;popularityTracker;constructor(e,t,s,a){super(6,["Oh no! Looks like your datacenter can't handle all this traffic!","Clients will not be pleased if your datacenter is too busy to reply.","You can see how busy a datacenter is by looking at its status bar."]),this.canvas=e,this.game=t,this.orchestrator=s,this.popularityTracker=a,this.hasNext=!0,this.hasHome=!0}run(){this.orchestrator.updateMessages(),this.game.update()}draw(){var e=this.canvas.getContext("2d"),t=this.canvas.width,s=this.canvas.height,a=Defaults.serverSize;this.popularityTracker.draw(s-95),TutorialHelper.drawLegend(this.canvas,!0),Utilities.drawCircleHighlight(t/2+a/2-7,s/2+1,a/2,e)}}class TutorialStep8 extends TutorialStep{canvas;game;orchestrator;popularityTracker;fader;constructor(e,t,s,a,i){super(7,["Thankfully, you are popular enough to afford to UPGRADE your datacenter.","As your popularity grows, you will be able to upgrade it even more.","Press SPACE to pause the game and select an upgrade."]),this.canvas=e,this.game=t,this.orchestrator=s,this.popularityTracker=a,this.fader=i,this.hasHome=!0,this.advanceOnSpace=!0}setup(){var e=this.canvas.width,t=this.canvas.height;this.fader.addPermanentText({x:e/2,y:t-116,font:"20px sans-serif",fontSize:20,fontWeight:"",color:{r:255,g:0,b:0},id:"upgradeTut",text:"- Upgrade available! -",life:1e3,alpha:0,delta:0})}run(){this.orchestrator.updateMessages(),this.game.update()}draw(){var e=this.canvas.getContext("2d"),t=this.canvas.width,s=this.canvas.height;this.popularityTracker.draw(s-95),TutorialHelper.drawLegend(this.canvas,!0),Utilities.drawText({x:t/2,y:s-95,text:"Press space to pause",font:"18px sans-serif",align:"center",color:"darkGray"},e)}}class TutorialStep9 extends TutorialStep{canvas;game;fader;constructor(e,t,s){super(8,["Let's improve your datacenter's speed.","This way it will process the clients' requests faster.","Select the third upgrade (Improve speed at one location)."]),this.canvas=e,this.game=t,this.fader=s;let r=e.getContext("2d"),o=e.width,h=e.height,a=[],n=Defaults.serverSize,i=h/2+150,c=(a.push(new SpecialButton(250,i,100,100,"#333333","white",2,()=>{},e=>{Utilities.drawText({x:225,y:i,text:"+",font:"45px monospace",align:"center",color:"red"},r),Utilities.drawRect({x:265,y:i,width:n,height:n,color:"#DDDDDD",borderColor:"red"},r),Utilities.drawStar({x:250-n/2+22,y:i+n/2-9,outerRadius:4,innerRadius:2,color:"#BBBBBB",borderColor:"#999999"},r),Utilities.drawRect({x:250+n/2+8,y:1+i,width:6,height:n-10,color:"#BBBBBB",borderColor:"#999999"},r),e&&Utilities.drawText({x:o/2,y:h-50,text:"Buy new datacenter",font:"20px monospace",align:"center",color:"red"},r)})),o/2),l=i,d=(a.push(new SpecialButton(c,l,100,100,"#333333","white",2,()=>{},e=>{var t=c+n/2-7,s=1+l,a=c-n/2+7,i=l+n/2-9;Utilities.drawRect({x:c,y:l,width:n,height:n,color:"#DDDDDD",borderColor:"#999999"},r),Utilities.drawRect({x:t,y:s,width:6,height:n-10,color:"salmon",borderColor:"red"},r),Utilities.drawStar({x:a,y:i,outerRadius:4,innerRadius:2,color:"#BBBBBB",borderColor:"#999999"},r),Utilities.drawLine(t,s-n/2+2,t,s-n/2-13,"red",3,r),Utilities.drawLine(t-1,s-n/2-13,5+t,s-n/2-6,"red",3,r),Utilities.drawLine(1+t,s-n/2-13,t-5,s-n/2-6,"red",3,r),e&&Utilities.drawText({x:o/2,y:h-50,text:"Scale off at one location",font:"20px monospace",align:"center",color:"red"},r)})),o-250),u=i;a.push(new SpecialButton(d,u,100,100,"#333333","white",2,()=>{this.game.servers[0].speed+=Defaults.serversSpeed,this.advance=!0},e=>{var t=d+n/2-7,s=1+u,a=d-n/2+7,i=u+n/2-9;Utilities.drawRect({x:d,y:u,width:n,height:n,color:"#DDDDDD",borderColor:"#999999"},r),Utilities.drawRect({x:t,y:s,width:6,height:n-10,color:"#BBBBBB",borderColor:"#999999"},r),Utilities.drawStar({x:a,y:i,outerRadius:4,innerRadius:2,color:"salmon",borderColor:"red"},r),Utilities.drawLine(a,i-8,a,i-21,"red",3,r),Utilities.drawLine(a-1,i-21,5+a,i-14,"red",3,r),Utilities.drawLine(1+a,i-21,a-5,i-14,"red",3,r),e&&Utilities.drawText({x:o/2,y:h-50,text:"Improve speed at one location",font:"20px monospace",align:"center",color:"red"},r)})),this.extraButtons=a}setup(){this.fader.removeFromPermanentQueue("upgradeTut")}draw(){var e=this.canvas.getContext("2d"),t=this.canvas.width,s=this.canvas.height;Utilities.drawRect({x:t/2,y:s/2,width:t,height:s-158,color:"#0360AE"},e),Utilities.drawText({x:t/2,y:s/2+60,text:"Choose an upgrade:",font:"25px monospace",align:"center"},e),Utilities.drawText({x:t/2,y:s/3,text:"~ Paused ~",font:"50px monospace",align:"center",color:"red"},e)}}class TutorialStep10 extends TutorialStep{canvas;game;orchestrator;popularityTracker;constructor(e,t,s,a){super(9,["Nice! You can see your datacenter's speed in the bottom left of it.","Now the clients can finish their data exchange without any more problems.","When a client is served successfully you will gain some more popularity."]),this.canvas=e,this.game=t,this.orchestrator=s,this.popularityTracker=a,this.hasHome=!0}setup(){this.game.clients[0].messagesToSend=2,this.game.clients[0].ACKsToReceive=2,this.game.clients[1].messagesToSend=6,this.game.clients[1].ACKsToReceive=6,this.game.clients[2].messagesToSend=10,this.game.clients[2].ACKsToReceive=10,this.orchestrator.messages.forEach(function(e){"ack"===e.status&&(e.receiver.ACKsToReceive+=1),"queued"!==e.status&&"req"!==e.status||(e.sender.ACKsToReceive+=1)})}run(){0===this.game.clients.length&&(this.hasNext=!0),this.orchestrator.updateMessages(),this.game.update()}draw(){var e=this.canvas.getContext("2d"),t=this.canvas.width,s=this.canvas.height,a=Defaults.serverSize;this.popularityTracker.draw(s-95),TutorialHelper.drawLegend(this.canvas,!0),Utilities.drawCircleHighlight(t/2-a/2+7,s/2+a/4,15,e)}}class TutorialStep11 extends TutorialStep{canvas;game;orchestrator;popularityTracker;fader;constructor(e,t,s,a,i){super(10,["Oh snap! Your datacenter is under a DDOS ATTACK! And more clients need serving!","This is likely to happen as you get more and more popular.","You'd better upgrade once again to cope with this situation."]),this.canvas=e,this.game=t,this.orchestrator=s,this.popularityTracker=a,this.fader=i,this.hasHome=!0,this.advanceOnSpace=!0}setup(){var e=this.canvas.width,t=this.canvas.height,s=this.game.servers[0],a=new Attacker(this.orchestrator,e/2,3*t/4,1e4,s),i=new Attacker(this.orchestrator,e/3,2*t/3,1e4,s),s=new Attacker(this.orchestrator,2*e/3,2*t/3,1e4,s),e={x:e/2,y:t-116,font:"20px sans-serif",fontSize:20,fontWeight:"",color:{r:255,g:0,b:0},id:"upgradeTut",text:"- Upgrade available! -",life:1e3,alpha:0,delta:0};this.spawnClients(),this.game.attackers.push(a,i,s),this.fader.addPermanentText(e)}run(){this.game.selectedClient&&(this.game.selectedClient=void 0),0===this.game.clients.length&&this.spawnClients(),this.orchestrator.updateMessages(),this.game.update()}draw(){var e=this.canvas.getContext("2d"),t=this.canvas.width,s=this.canvas.height;TutorialHelper.drawLegend(this.canvas,!0),Utilities.drawText({x:t/2,y:s-95,text:"Press space to pause",font:"18px sans-serif",align:"center",color:"darkGray"},e)}spawnClients(){var e=this.canvas.width,t=this.canvas.height,s=new Client(this.orchestrator,this.popularityTracker,e/4,t/3,1e4),e=new Client(this.orchestrator,this.popularityTracker,3*e/4,t/3,1e4);s.life=-21,e.life=-21,this.game.clients.push(s,e)}}class TutorialStep12 extends TutorialStep{canvas;game;fader;constructor(e,t,s){super(11,["This time let's buy a new datacenter.","This way you can connect the clients to it while your first one is under attack.","Select the first upgrade (Buy new datacenter)."]),this.canvas=e,this.game=t,this.fader=s;let r=e.getContext("2d"),o=e.width,h=e.height,a=[],n=Defaults.serverSize,i=h/2+150,c=(a.push(new SpecialButton(250,i,100,100,"#333333","white",2,()=>{var e=new Server(o/2,h/4);e.capacity=20,this.game.servers.push(e),this.advance=!0},e=>{Utilities.drawText({x:225,y:i,text:"+",font:"45px monospace",align:"center",color:"red"},r),Utilities.drawRect({x:265,y:i,width:n,height:n,color:"#DDDDDD",borderColor:"red"},r),Utilities.drawStar({x:250-n/2+22,y:i+n/2-9,outerRadius:4,innerRadius:2,color:"#BBBBBB",borderColor:"#999999"},r),Utilities.drawRect({x:250+n/2+8,y:1+i,width:6,height:n-10,color:"#BBBBBB",borderColor:"#999999"},r),e&&Utilities.drawText({x:o/2,y:h-50,text:"Buy new datacenter",font:"20px monospace",align:"center",color:"red"},r)})),o/2),l=i,d=(a.push(new SpecialButton(c,l,100,100,"#333333","white",2,()=>{},e=>{var t=c+n/2-7,s=1+l,a=c-n/2+7,i=l+n/2-9;Utilities.drawRect({x:c,y:l,width:n,height:n,color:"#DDDDDD",borderColor:"#999999"},r),Utilities.drawRect({x:t,y:s,width:6,height:n-10,color:"salmon",borderColor:"red"},r),Utilities.drawStar({x:a,y:i,outerRadius:4,innerRadius:2,color:"#BBBBBB",borderColor:"#999999"},r),Utilities.drawLine(t,s-n/2+2,t,s-n/2-13,"red",3,r),Utilities.drawLine(t-1,s-n/2-13,5+t,s-n/2-6,"red",3,r),Utilities.drawLine(1+t,s-n/2-13,t-5,s-n/2-6,"red",3,r),e&&Utilities.drawText({x:o/2,y:h-50,text:"Scale off at one location",font:"20px monospace",align:"center",color:"red"},r)})),o-250),u=i;a.push(new SpecialButton(d,u,100,100,"#333333","white",2,()=>{},e=>{var t=d+n/2-7,s=1+u,a=d-n/2+7,i=u+n/2-9;Utilities.drawRect({x:d,y:u,width:n,height:n,color:"#DDDDDD",borderColor:"#999999"},r),Utilities.drawRect({x:t,y:s,width:6,height:n-10,color:"#BBBBBB",borderColor:"#999999"},r),Utilities.drawStar({x:a,y:i,outerRadius:4,innerRadius:2,color:"salmon",borderColor:"red"},r),Utilities.drawLine(a,i-8,a,i-21,"red",3,r),Utilities.drawLine(a-1,i-21,5+a,i-14,"red",3,r),Utilities.drawLine(1+a,i-21,a-5,i-14,"red",3,r),e&&Utilities.drawText({x:o/2,y:h-50,text:"Improve speed at one location",font:"20px monospace",align:"center",color:"red"},r)})),this.extraButtons=a}setup(){this.fader.removeFromPermanentQueue("upgradeTut")}draw(){var e=this.canvas.getContext("2d"),t=this.canvas.width,s=this.canvas.height;Utilities.drawRect({x:t/2,y:s/2,width:t,height:s-158,color:"#0360AE"},e),Utilities.drawText({x:t/2,y:s/2+60,text:"Choose an upgrade:",font:"25px monospace",align:"center"},e),Utilities.drawText({x:t/2,y:s/3,text:"~ Paused ~",font:"50px monospace",align:"center",color:"red"},e)}}class TutorialStep13 extends TutorialStep{canvas;game;orchestrator;popularityTracker;constructor(e,t,s,a){super(12,["Perfect! Now you have a new datacenter at your disposal.","This is when a good load balancing strategy will start to matter.","Indeed you would be wiser to connect the clients to the new datacenter."]),this.canvas=e,this.game=t,this.orchestrator=s,this.popularityTracker=a,this.hasHome=!0}setup(){this.game.clients[0].life=-21,this.game.clients[1].life=-21}run(){var e,t,s;0===this.game.clients.length&&(s=this.canvas.width,e=this.canvas.height,t=new Client(this.orchestrator,this.popularityTracker,s/4,e/3,1e4),s=new Client(this.orchestrator,this.popularityTracker,3*s/4,e/3,1e4),t.life=-21,s.life=-21,this.game.clients.push(t,s)),void 0!==this.game.clients[0].connectedTo&&void 0!==this.game.clients[1].connectedTo&&(this.advance=!0),this.orchestrator.updateMessages(),this.game.update()}draw(){var e=this.canvas.height;this.popularityTracker.draw(e-95),TutorialHelper.drawLegend(this.canvas,!0)}}class TutorialStep14 extends TutorialStep{canvas;game;orchestrator;popularityTracker;constructor(e,t,s,a,i){super(13,["Excellent! By now you should know all the basics.","This tutorial is finished.","You can start a new game or go back to the main menu."]),this.canvas=e,this.game=t,this.orchestrator=s,this.popularityTracker=a;t=e.width,s=e.height;this.hasHome=!0,this.extraButtons=[new Button(t/3,s-40,120,40,"New game","#FFFFFF",()=>i.execute())]}run(){this.orchestrator.updateMessages(),this.game.update()}draw(){var e=this.canvas.height;this.popularityTracker.draw(e-95),TutorialHelper.drawLegend(this.canvas,!0)}}class BorderButton extends Button{hoverColor;borderWidth;constructor(e,t,s,a,i,r,o,h,n){super(e,t,s,a,i,r,n),this.hoverColor=o,this.borderWidth=h}draw(e,t){e=e?this.hoverColor:this.color;Utilities.drawRect({x:this.x,y:this.y,width:this.width,height:this.height,borderColor:e,borderWidth:this.borderWidth},t),Utilities.drawText({x:this.x,y:this.y,text:this.text,font:"15px monospace",align:"center",color:e},t)}}class Upgrade{canvas;game;upgradesTracker;scheduler;gameArea;fader;id=Defaults.gameModes.UPGRADE;constructor(e,t,s,a,i,r){this.canvas=e,this.game=t,this.upgradesTracker=s,this.scheduler=a,this.gameArea=i,this.fader=r}getButtons(){var e=this.canvas.width,t=this.canvas.height;let s=[new Button(e/2,t-100,120,40,"Cancel","#333333",()=>this.game.switchMode(Defaults.gameModes.PAUSE))];switch(this.upgradesTracker.selectedUpgrade){case"speed":s=[...s,...this.createServerButtons(e=>e.speed+=2)];break;case"capacity":s=[...s,...this.createServerButtons(e=>e.capacity+=Defaults.serversCapacity)];break;case"server":s=[...s,this.createAreaButton(Math.floor(e/6),Math.floor(t/6),"nw"),this.createAreaButton(Math.floor(e/2),Math.floor(t/6),"n"),this.createAreaButton(Math.floor(5*e/6)+1,Math.floor(t/6),"ne"),this.createAreaButton(Math.floor(e/6),Math.floor(t/2),"w"),this.createAreaButton(Math.floor(e/2),Math.floor(t/2),"c"),this.createAreaButton(Math.floor(5*e/6)+1,Math.floor(t/2),"e"),this.createAreaButton(Math.floor(e/6),Math.floor(5*t/6),"sw"),this.createAreaButton(Math.floor(e/2),Math.floor(5*t/6),"s"),this.createAreaButton(Math.floor(5*e/6)+1,Math.floor(5*t/6),"se")]}return s}update(){var e=this.canvas.getContext("2d"),t=this.canvas.width,s=this.canvas.height;e.clearRect(0,0,t,s),this.gameArea.drawServers();let a;switch(this.upgradesTracker.selectedUpgrade){case"speed":case"capacity":a="location";break;case"server":a="zone"}Utilities.drawText({x:t/2,y:60,text:`~ Select ${a} ~`,font:"30px monospace",align:"center",color:"red"},e)}createAreaButton(e,t,s){var a=this.canvas.width,i=this.canvas.height;return new BorderButton(e,t,Math.floor(a/3),Math.floor(i/3),"","#CCCCCC","limeGreen",1,()=>{this.scheduler.createServer(s),this.selectUpgrade()})}createServerButton(e,t){return new BorderButton(e.x,e.y,Defaults.serverSize+2,Defaults.serverSize+2,"","rgba(0,0,0,0)","limeGreen",2,()=>{t(),this.selectUpgrade()})}createServerButtons(t){return this.game.servers.map(e=>this.createServerButton(e,()=>t(e)))}selectUpgrade(){this.upgradesTracker.selectedUpgrade=void 0,--this.upgradesTracker.upgradesAvailable,this.fader.removeFromPermanentQueue("upgrade"),this.game.switchMode(Defaults.gameModes.PAUSE)}}class FpsCounter{lastTimestamp=Date.now();fps=0;update(){var e=Date.now(),t=(e-this.lastTimestamp)/1e3;this.fps=Math.floor(1/t),this.lastTimestamp=e}logFps(){let e=document.getElementById("fps");var t;e||((t=document.getElementById("log"))&&(t.innerHTML='Fps: <span id="fps"></span><br />'+t.innerHTML),e=document.getElementById("fps")),e.innerHTML=this.fps.toString()}}class Application{scenes;game;ui;cursor;canvas;fpsCounter;clouds;activeScene;logActive=!1;constructor(e,t,s,a,i,r,o){this.scenes=e,this.game=t,this.ui=s,this.cursor=a,this.canvas=i,this.fpsCounter=r,this.clouds=o;t=i.width,s=i.height;this.activeScene=e[0],o.setSkyColor("#0360AE"),this.createCloud(t/4,s/4),this.createCloud(0-t/4,s/3),this.createCloud(t/2,s/2),this.createCloud(0-t/2,3*s/4),this.createCloud(3*t/4,2*s/3),this.createCloud(0-3*t/4,s/2),document.addEventListener("keypress",e=>this.keyboardHandler(e)),window.addEventListener("blur",()=>this.blurHandler())}static build(e){var t=document.getElementById("canvas"),s=t.getContext("2d"),a=new Audio("assets/music.mp3"),s=new TextFader(s),i=new FpsCounter,r=new MessageOrchestrator,o=new UpgradesTracker,h=new PopularityTracker(s,o,t),n=new GameUI(a,t),c=new GameTracker(h,n),l=new CursorTracker(c,t,n),d=new Scheduler(h,s,r,t,c),u=new GameArea(t,c,r,h,o,l,s),p=new NewGame(r,o,h,c,d,s),g=new Credits(t,e,c),m=new GameOver(t,e,c,r,h,p),w=new Pause(t,e,c,o,n,p),o=new Upgrade(t,c,o,d,u,s),d=new Game(t,c,d,r,u,s),h=new Tutorial([new TutorialStep1(t,c),new TutorialStep2(t),new TutorialStep3(t,c,r,h),new TutorialStep4(c),new TutorialStep5(t,c,r,h),new TutorialStep6(t,c,r,h),new TutorialStep7(t,c,r,h),new TutorialStep8(t,c,r,h,s),new TutorialStep9(t,c,s),new TutorialStep10(t,c,r,h),new TutorialStep11(t,c,r,h,s),new TutorialStep12(t,c,s),new TutorialStep13(t,c,r,h),new TutorialStep14(t,c,r,h,p)],t,u,s,c,r),u=new Menu(t,e,c,n,h,p);return l.bind(),a.loop=!0,new Application([u,d,m,g,w,o,h],c,n,l,t,i,e)}run(){setInterval(()=>this.mainLoop(),1e3/Defaults.frameRate)}mainLoop(){this.activeScene.id!==this.game.currentGameMode&&(this.activeScene=this.scenes.find(e=>e.id===this.game.currentGameMode)),this.clouds.update(1e3/Defaults.frameRate),this.activeScene.update(),this.ui.buttons=this.activeScene.getButtons(),this.drawButtons(),this.logActive&&(this.fpsCounter.update(),this.fpsCounter.logFps())}createCloud(e,t){var s=this.getRandomInt(350,500),a=this.getRandomInt(s,700),i=this.getRandomInt(15,30),r=this.getRandomInt(180,255),r={r:r,g:r,b:r,a:.1},o=this.getRandomInt(100,200);this.clouds.add(e,t,s,a,i,r,o)}getRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}drawButtons(){let s=this.canvas.getContext("2d"),a=this.cursor.mouseX,i=this.cursor.mouseY;this.ui.buttons.forEach(e=>{var t=a>e.x-(e.width+2)/2&&a<e.x+(e.width+2)/2&&i>e.y-(e.height+4)/2&&i<e.y+(e.height+2)/2;e.draw(t,s)})}blurHandler(){this.game.currentGameMode===Defaults.gameModes.GAME&&this.game.switchMode(Defaults.gameModes.PAUSE)}keyboardHandler(e){e.preventDefault()," "===e.key&&((e=this.game).currentGameMode===Defaults.gameModes.GAME?e.switchMode(Defaults.gameModes.PAUSE):e.currentGameMode===Defaults.gameModes.PAUSE&&e.switchMode(Defaults.gameModes.GAME))}}