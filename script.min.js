class Message{sender;receiver;speed;position;status;life;constructor(e,t){this.sender=e,this.receiver=t,this.position={...e.position},this.status="req",this.life=0,this.speed=VectorMath.direction(e.position,t.position).multiply(Defaults.messageVelocity)}update(e){this.position=this.speed.divide(1e3/e).add(this.position)}invertDirection(){var e=this.sender;this.sender=this.receiver,this.receiver=e,this.speed=this.speed.invert()}}class MessageOrchestrator{messages=[];totalACKs=0;avgResponseTime=0;createMessage(e,t){e=new Message(e,t);this.messages.push(e)}registerAck(e){this.totalACKs+=1,this.avgResponseTime=(e.life+(this.totalACKs-1)*this.avgResponseTime)/this.totalACKs}reset(){this.messages=[],this.totalACKs=0,this.avgResponseTime=0}updateMessages(t){var a=Defaults.clientSize;for(let e=0;e<this.messages.length;e+=1){var s,r,i,o=this.messages[e];o.life+=t/1e3,"req"===o.status&&void 0===o.sender.connectedTo?this.messages.splice(e--,1):("ack"===o.status||"nack"===o.status)&&void 0===o.receiver.connectedTo||"done"===o.status?this.messages.splice(e--,1):"queued"!=o.status&&(s=o.receiver,r=o.position,i=s.position,r.x<i.x+a/2&&r.x>i.x-a/2&&r.y<i.y+a/2&&r.y>i.y-a/2?s.receiveMessage(o):o.update(t))}}}class Attacker{orchestrator;position;messages;connectedTo;lastMessageTime;messagesToSend;messagesToReceive;constructor(e,t,a,s){this.orchestrator=e,this.position=t,this.messages=a,this.connectedTo=s,this.connectedTo=s,this.lastMessageTime=0,this.messagesToSend=a,this.messagesToReceive=a}sendMessage(e){this.orchestrator.createMessage(this,this.connectedTo),--this.messagesToSend,this.lastMessageTime=e}receiveMessage(e){e.status="done",--this.messagesToReceive}}class Defaults{static accentColor="#ff0000";static accentColorMuted="#fa8072";static attackerBorderColor="#000000";static attackerColor="#333333";static attackerConnectionColor="#696969";static attackerTextColor="#ffffff";static backgroundBorderColor="#02467f";static backgroundColor="#0360ae";static clientBorderColor="#696969";static clientColor="#808080";static clientConnectionColor="#a9a9a9";static clientSize=30;static clientSpeed=2;static clientTextColor="#ffffff";static dangerColor="#ff0000";static dangerColorDark="#b22222";static dangerColorMuted="#ff6347";static dangerColorMutedDark="#cd5c5c";static defaultColor="#000000";static frameRate=60;static gameLength=5;static highlightColor="#add8e6";static highlightWidth=3;static maxClientWaitTime=9;static messageAckBorderColor="#32cd32";static messageAckColor="#00ff00";static messageNackBorderColor=Defaults.dangerColorMutedDark;static messageNackColor=Defaults.dangerColorMuted;static messageReqBorderColor="#87ceeb";static messageReqColor="#add8e6";static messageSize=6;static messageVelocity=200;static primaryColor="#ffffff";static primaryColorMuted="#dddddd";static primaryColorMutedTransparent="rgba(200,200,200,.5)";static primaryColorTransparent="rgba(255,255,255,.6)";static secondaryColor="#333333";static secondaryColorTransparent="rgba(0,0,0,.1)";static secondaryColorMuted="#a9a9a9";static serverCapacity=80;static serverBorderColor="#004500";static serverColor="#008000";static serverSize=40;static serverSpeed=3.5;static successColor="#00ff00";static gameModes={MENU:0,GAME:1,GAME_OVER:2,CREDITS:3,PAUSE:4,UPGRADE:5,TUTORIAL:6};static serverDefaults={size:Defaults.serverSize,color:Defaults.serverColor,borderColor:Defaults.serverBorderColor,queueColor:Defaults.serverColor,queueBorderColor:Defaults.serverBorderColor,speedColor:Defaults.successColor,speedBorderColor:Defaults.serverBorderColor};static serverDisabledDefaults={size:Defaults.serverSize,color:"#DDDDDD",borderColor:"#999999",queueColor:"#BBBBBB",queueBorderColor:"#999999",speedColor:"#BBBBBB",speedBorderColor:"#999999"}}class Canvas{canvasElement;context;constructor(e){e=(this.canvasElement=e).getContext("2d");if(!e)throw"Could not get 2D context from canvas";this.context=e}get center(){return{x:this.width/2,y:this.height/2}}get height(){return this.canvasElement.height}get width(){return this.canvasElement.width}clear(){this.context.clearRect(0,0,this.width,this.height)}createLinearGradient(e,t,a,s){return this.context.createLinearGradient(e,t,a,s)}drawArrow(e){var t=this.context,a=e.from,s=e.to,r=e.barbsAngle??Math.PI/5,i=e.barbsLength??8,o=VectorMath.direction(s,a),n=o.rotate(r).multiply(i).add(s),o=o.rotate(-r).multiply(i).add(s);t.strokeStyle=e?.color??Defaults.defaultColor,t.lineWidth=e?.width??1,t.lineJoin="round",t.beginPath(),t.moveTo(a.x,a.y),t.lineTo(s.x,s.y),t.lineTo(n.x,n.y),t.moveTo(s.x,s.y),t.lineTo(o.x,o.y),t.stroke()}drawCircle(e){var t=this.context,a=e.position;t.beginPath(),t.arc(a.x,a.y,e.radius,0,2*Math.PI,!0),t.closePath(),this.draw(e)}drawLine(e){var t=this.context,a=e.from,s=e.to;t.strokeStyle=e?.color??Defaults.defaultColor,t.lineWidth=e?.width??1,t.beginPath(),t.moveTo(a.x,a.y),t.lineTo(s.x,s.y),t.stroke()}drawPolygon(e){let t=this.context,a=[...e.points],s=a.shift();t.beginPath(),t.moveTo(s.x,s.y),a.forEach(e=>t.lineTo(e.x,e.y)),t.closePath(),this.draw(e)}drawRect(e){var t=this.context,a=e.position,s=e.width,r=e.height;t.beginPath(),t.rect(a.x-s/2,a.y-r/2,s,r),t.closePath(),this.draw(e)}drawStar(e){var t=this.context,a=e.position,s=e.spikes??5,r=e.outerRadius,i=e.innerRadius,o=Math.PI/s;let n=Math.PI/2*3;t.beginPath(),t.moveTo(a.x,a.y-r);for(let e=0;e<s;e+=1){var c=VectorMath.shift(a,n,r),c=(t.lineTo(c.x,c.y),n+=o,VectorMath.shift(a,n,i));t.lineTo(c.x,c.y),n+=o}t.lineTo(a.x,a.y-r),t.closePath(),this.draw(e)}drawText(e){var t=this.context,a=e.position;let s=e.fontSize+"px "+(e.fontFamily??"monospace");e.fontVariant&&(s=e.fontVariant+" "+s),e.fontWeight&&(s=e.fontWeight+" "+s),t.font=s,t.textAlign=e.align??"start",t.textBaseline=e.baseline??"middle",t.fillStyle=e.color??Defaults.defaultColor,t.fillText(e.text,a.x,a.y)}drawTriangle(e){var t=this.context,a=e.position.x,s=e.position.y,r=e.base,i=e.height;t.beginPath(),t.moveTo(a,s-i/2),t.lineTo(a+r/2,s+i/2),t.lineTo(a-r/2,s+i/2),this.draw(e)}draw(e){var t=this.context;e.color&&(t.fillStyle=e.color,t.fill()),e.borderColor&&(t.strokeStyle=e.borderColor,t.lineWidth=e.borderWidth??1,t.stroke())}}class TextFader{canvas;queues;constructor(e){this.canvas=e,this.queues={permanent:[],temporary:[]}}draw(){for(let e=0;e<this.queues.temporary.length;e++){var t=this.queues.temporary[e];for(let e=0;e<t.activeTexts.length;e++){var a=t.activeTexts[e];this.drawText(a,t.position)}}for(let e=0;e<this.queues.permanent.length;e+=1){var s=this.queues.permanent[e];this.drawText(s,s.position)}}update(t){for(let e=0;e<this.queues.temporary.length;e++){var a=this.queues.temporary[e];for(let e=0;e<a.activeTexts.length;e++){var s=a.activeTexts[e];s.delta+=70*t/1e3,s.fadeIn?(s.alpha+=.02,1<=s.alpha&&(s.fadeIn=!1)):(s.alpha-=.02,s.alpha<=0&&a.activeTexts.splice(e--,1))}0<a.queuedTexts.length&&(0===a.activeTexts.length||a.activeTexts[a.activeTexts.length-1].delta>a.queuedTexts[0].fontSize)&&a.activeTexts.push(a.queuedTexts.shift())}for(let e=0;e<this.queues.permanent.length;e+=1){var r=this.queues.permanent[e];r.fadeIn?(r.alpha+=.05,1<=r.alpha&&(r.fadeIn=!1)):(r.alpha-=.05,r.alpha<=0&&(r.fadeIn=!0))}}addText(e){let t=this.getId(e.position),a=this.queues.temporary.find(e=>e.id==t);a=a||this.createQueue(e.position),e.life??=1e3,e.alpha=e.fadeIn?0:1,e.delta=0,a.queuedTexts.push(e)}addPermanentText(t){for(let e=0;e<this.queues.permanent.length;e++)if(this.queues.permanent[e].id===t.id)return;t.life||(t.life=1e3),t.alpha=0,t.fadeIn=!0,this.queues.permanent.push(t)}removeFromPermanentQueue(t){for(let e=0;e<this.queues.permanent.length;e++)if(this.queues.permanent[e].id===t)return void this.queues.permanent.splice(e,1)}emptyQueues(){this.queues={permanent:[],temporary:[]}}createQueue(e){e={id:this.getId(e),position:{...e},activeTexts:[],queuedTexts:[]};return this.queues.temporary.push(e),e}drawText(e,t){var a=e.delta??0,{r:s,g:r,b:i}=e.rgbColor,s=`rgba(${s}, ${r}, ${i}, ${e.alpha})`;this.canvas.drawText({...e,position:{x:t.x,y:t.y-a},fontFamily:"Arial",align:"center",color:s})}getId(e){return e.x.toString()+e.y.toString()}}class Utilities{static defaultButton(e,t,a){return new SimpleButton(e,120,40,t,Defaults.primaryColor,a)}static drawCircleHighlight(e,t,a){e={position:e,radius:t,borderColor:"fireBrick",borderWidth:2},t={...e,radius:t+1,borderColor:"red"};a.drawCircle(e),a.drawCircle(t)}static drawServer(e,t,a){var s=(t={...Defaults.serverDefaults,...t}).size,r=e.position;let i=Math.max(0,e.capacity/Defaults.serverCapacity-1);for(;-1<i;--i)a.drawRect({position:{x:r.x+3*i,y:r.y-3*i},width:s,height:s,color:t.color,borderColor:t.borderColor});var o=Defaults.serverSpeed,n=s-10,c=r.x+s/2-7,h=r.y+1,l=e.queue.length/e.capacity*100*n/100,d=c,u=h+n/2-l/2,c=(a.drawRect({position:{x:c,y:h},width:7,height:2+n,color:t.queueColor,borderColor:t.queueBorderColor}),a.createLinearGradient(d,h+n/2,d,h-n/2));for(c.addColorStop(.5,Defaults.successColor),c.addColorStop(1,Defaults.dangerColor),a.drawRect({position:{x:d,y:u},width:5,height:l,color:c}),i=e.speed;0<i;i-=o){var p=r.x-s/2+7,g=r.y+s/2-4-i/o*5;a.drawStar({position:{x:p,y:g},outerRadius:4,innerRadius:2,color:t.speedColor,borderColor:t.speedBorderColor})}}static invertColor(e){e=e.substring(1);var t=parseInt(e,16);return e="#"+(e=("000000"+(e=(t^=16777215).toString(16))).slice(-6))}}class UpgradesTracker{upgrades=[100,200,300,500,700,1e3,1300,1700,2100,2600,3100,3700,4300,5e3];nextUpgradeIndex=0;upgradesAvailable=0;selectedUpgrade;get nextUpgrade(){return this.nextUpgradeIndex>=this.upgrades.length?1/0:this.upgrades[this.nextUpgradeIndex]}increaseUpgrades(){this.upgradesAvailable+=1,this.nextUpgradeIndex+=1}reset(){this.nextUpgradeIndex=0,this.upgradesAvailable=0,this.selectedUpgrade=void 0}}class PopularityTracker{fader;upgrades;canvas;popularity;constructor(e,t,a){this.fader=e,this.upgrades=t,this.canvas=a,this.popularity=0}draw(e){this.canvas.drawText({position:{x:10,y:e},text:"Popularity: "+this.popularity,fontSize:18,fontFamily:"sans-serif"})}reset(){this.popularity=0}updatePopularity(e,t){var a=5<=t?16:12,s=t<0?{r:150,g:0,b:0}:{r:0,g:150,b:0},e={x:e.position.x,y:e.position.y-8-Defaults.clientSize/2};this.fader.addText({text:t.toString(),rgbColor:s,fontSize:a,fontWeight:"bold",alpha:1,delta:0,position:e}),this.popularity+=t,this.popularity>=this.upgrades.nextUpgrade&&this.upgrades.increaseUpgrades()}}class Client{orchestrator;popularity;position;messages;life;connectedTo;lastMessageTime;messagesToSend;ACKsToReceive;NACKsToDie;constructor(e,t,a,s){this.orchestrator=e,this.popularity=t,this.position=a,this.messages=s,this.life=0,this.lastMessageTime=0,this.messagesToSend=s,this.ACKsToReceive=s,this.NACKsToDie=Math.floor(s/3)}sendMessage(e){if(!this.connectedTo)throw"Disconnected client cannot send messages.";this.orchestrator.createMessage(this,this.connectedTo),--this.messagesToSend,this.lastMessageTime=e}receiveMessage(e){let t;"ack"===e.status?(--this.ACKsToReceive,t=1,0===this.ACKsToReceive&&(t+=5),this.orchestrator.registerAck(e)):(--this.NACKsToDie,t=-1,0<this.NACKsToDie?this.messagesToSend+=1:t-=5),this.popularity.updatePopularity(this,t),e.status="done"}}class Server{position;queue;lastMessageTime;capacity;speed;constructor(e){this.position=e,this.queue=[],this.lastMessageTime=0,this.capacity=Defaults.serverCapacity,this.speed=Defaults.serverSpeed}sendMessage(e){var t=this.queue.shift();t&&(t.status="ack",t.invertDirection(),this.lastMessageTime=e)}receiveMessage(e){e.position={...this.position},this.queue.length<this.capacity?(this.queue.push(e),e.status="queued"):(e.status="nack",e.invertDirection())}}class VolumeButton{position;onClick;width;height;isOn=!1;constructor(e,t,a){this.position=e,this.onClick=a,this.width=t,this.height=t}draw(e,t){var a=this.position,s=this.width,r=this.height,i=e?Defaults.primaryColor:Defaults.primaryColorTransparent,o=this.isOn?"On":"Off";t.drawRect({position:{x:a.x-s/4+1,y:a.y},width:s/4+1,height:r/2-1,color:i}),t.drawPolygon({position:a,points:[{x:a.x-1,y:a.y-r/4},{x:a.x+s/4,y:a.y-r/2+1},{x:a.x+s/4,y:a.y+r/2-1},{x:a.x-1,y:a.y+r/4}],color:i}),this.isOn||t.drawLine({from:{x:a.x-s/2,y:a.y+r/2},to:{x:a.x+s/2,y:a.y-r/2},color:Defaults.accentColor,width:2}),e&&t.drawText({position:{x:a.x,y:a.y+s/2+2},text:"Music: "+o,fontSize:10,align:"center",baseline:"top",color:Defaults.primaryColor})}}class GameUI{buttons=[];volumeButton;constructor(e,t){t={x:t.width-40,y:t.height-40};this.volumeButton=new VolumeButton(t,20,()=>{e.paused?e.play():e.pause(),this.volumeButton.isOn=!e.paused})}click(a,s){this.buttons.some(e=>{var t=e.position;if(a>t.x-e.width/2&&a<t.x+e.width/2&&s>t.y-e.height/2&&s<t.y+e.height/2)return e.onClick(),!0})}}class GameTracker{popularityTracker;ui;orchestrator;selectedClient;currentGameMode=0;clientsServed=0;droppedConnections=0;failedConnections=0;elapsedTime=0;servers=[];clients=[];attackers=[];constructor(e,t,a){this.popularityTracker=e,this.ui=t,this.orchestrator=a}switchMode(e){this.ui.buttons=[],this.currentGameMode=e}reset(){this.selectedClient=void 0,this.clientsServed=0,this.droppedConnections=0,this.failedConnections=0,this.elapsedTime=0,this.servers=[],this.clients=[],this.attackers=[],this.switchMode(Defaults.gameModes.GAME)}update(e){this.elapsedTime+=e/1e3,this.orchestrator.updateMessages(e),this.updateClients(e),this.updateServers(),this.updateAttackers()}updateServers(){let t=this.elapsedTime;this.servers.forEach(function(e){t-e.lastMessageTime>1/e.speed&&e.sendMessage(t)})}updateClients(t){var a=this.elapsedTime,s=60*Defaults.gameLength-a;for(let e=0;e<this.clients.length;e++){var r=this.clients[e];s<=0&&0<r.messagesToSend&&(r.ACKsToReceive-=r.messagesToSend,r.messagesToSend=0),0===r.messagesToSend&&0===r.ACKsToReceive?(this.clients.splice(e--,1),this.clientsServed+=1):0===r.NACKsToDie?(r.connectedTo=void 0,this.clients.splice(e--,1),this.droppedConnections+=1):void 0===r.connectedTo?(r.life+=t/1e3,(s<=0||r.life>Defaults.maxClientWaitTime)&&(this.clients.splice(e--,1),r===this.selectedClient&&(this.selectedClient=void 0),this.failedConnections+=1,this.popularityTracker.updatePopularity(r,-10))):0<r.messagesToSend&&a-r.lastMessageTime>1/Defaults.clientSpeed&&r.sendMessage(a)}}updateAttackers(){var t=this.elapsedTime;for(let e=0;e<this.attackers.length;e+=1){var a=this.attackers[e];0===a.messagesToReceive?this.attackers.splice(e--,1):0!=a.messagesToSend&&t-a.lastMessageTime>.5/Defaults.clientSpeed&&a.sendMessage(t)}}}class MathHelper{static clamp(e,t,a){return Math.min(Math.max(e,t),a)}static nearestPower(e,t){return Math.pow(t,this.nearestRoot(e,t))}static nearestRoot(e,t){return Math.ceil(Math.log(e)/Math.log(t))}static random(e,t){return Math.random()*(t-e)+e}static randomInt(e,t){return Math.floor(MathHelper.random(e,t))}static round(e,t){t=Math.pow(10,t);return Math.round(e*t)/t}}class VectorMath{static zero={x:0,y:0};static add(e,t){return new VectorCalculator({x:e.x+t.x,y:e.y+t.y})}static angle(e,t){return e=this.normalize(e),t=this.normalize(t),Math.acos(this.dotProduct(e,t))}static clamp(e,t,a){return new VectorCalculator({x:MathHelper.clamp(e.x,t,a),y:MathHelper.clamp(e.y,t,a)})}static direction(e,t){return this.subtract(t,e).normalize()}static distance(e,t){t=this.subtract(t,e);return Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2))}static divide(e,t){return new VectorCalculator({x:e.x/t,y:e.y/t})}static dotProduct(e,t){return e.x*t.x+e.y*t.y}static hadamardProduct(e,t){return new VectorCalculator({x:e.x*t.x,y:e.y*t.y})}static invert(e){return this.multiply(e,-1)}static isEqual(e,t){return e.x===t.x&&e.y===t.y}static magnitude(e){return Math.sqrt(e.x*e.x+e.y*e.y)}static multiply(e,t){return new VectorCalculator({x:e.x*t,y:e.y*t})}static normalize(e){var t=this.magnitude(e);return this.divide(e,t)}static rotate(e,t){var a=Math.cos(t),t=Math.sin(t);return new VectorCalculator({x:a*e.x-t*e.y,y:t*e.x+a*e.y})}static round(e,t){return new VectorCalculator({x:MathHelper.round(e.x,t),y:MathHelper.round(e.y,t)})}static shift(e,t,a){return new VectorCalculator({x:e.x+Math.cos(t)*a,y:e.y+Math.sin(t)*a})}static subtract(e,t){return new VectorCalculator({x:e.x-t.x,y:e.y-t.y})}}class AttackerFactory{game;orchestrator;constructor(e,t){this.game=e,this.orchestrator=t}create(e,t,a){e=new Attacker(this.orchestrator,e,t,a);return this.game.attackers.push(e),e}}class ClientFactory{game;orchestrator;popularityTracker;constructor(e,t,a){this.game=e,this.orchestrator=t,this.popularityTracker=a}create(e,t){e=new Client(this.orchestrator,this.popularityTracker,e,t);return this.game.clients.push(e),e}}class ServerFactory{game;constructor(e){this.game=e}create(e){e=new Server(e);return this.game.servers.push(e),e}}class Scheduler{popularityTracker;canvas;game;clientFactory;attackerFactory;serverFactory;timeLastDDoS=0;minClientMessages=25;maxClientMessages=35;attackersMessages=30;attackersNumber=1;spawnRate=6;attackRate=80;timeLastClient=1-this.spawnRate;constructor(e,t,a,s,r,i){this.popularityTracker=e,this.canvas=t,this.game=a,this.clientFactory=s,this.attackerFactory=r,this.serverFactory=i}schedule(){var e=this.popularityTracker.popularity,t=this.game.elapsedTime,a=60*Defaults.gameLength-t;a>Defaults.maxClientWaitTime&&t-this.timeLastClient>Math.max(this.spawnRate-Math.cbrt(e/40),1.6)&&.3<Math.random()&&this.createClient(),30<a&&t-this.timeLastDDoS>Math.max(this.attackRate-e/100,60)&&.3<Math.random()&&this.initiateDDoS()}reset(){this.timeLastDDoS=0,this.timeLastClient=1-this.spawnRate}createServer(e){var t=this.canvas.width,a=this.canvas.height,s=Defaults.serverSize,s={x:s,y:s},t={x:t/3,y:a/3};let r;switch(e){case"nw":r={x:0,y:0};break;case"n":r={x:1,y:0};break;case"ne":r={x:2,y:0};break;case"w":r={x:0,y:1};break;case"c":r={x:1,y:1};break;case"e":r={x:2,y:1};break;case"sw":r={x:0,y:2};break;case"s":r={x:1,y:2};break;case"se":r={x:2,y:2};break;default:throw`Invalid zone: ${e}.`}var a=VectorMath.hadamardProduct(t,r),i=VectorMath.add(VectorMath.zero,a).add(s),t=VectorMath.add(t,a).subtract(s),a=this.getRandomPositionBounded(i,t);this.serverFactory.create(a)}createClient(){var e=this.game.elapsedTime,t=MathHelper.randomInt(this.minClientMessages,this.maxClientMessages)+Math.floor(this.popularityTracker.popularity/100),a=this.getRandomPosition(Defaults.clientSize);this.clientFactory.create(a,t),this.timeLastClient=e}initiateDDoS(){var e=this.game.elapsedTime,t=Math.floor(this.popularityTracker.popularity/400),a=this.attackersMessages+t,s=this.attackersNumber+t;for(let e=0;e<s;e+=1){var r=this.getRandomPosition(Defaults.clientSize),i=this.findClosestServer(r);i&&this.attackerFactory.create(r,a,i)}this.timeLastDDoS=e}checkCollisions(e){var t=Defaults.serverSize,a=Defaults.clientSize,s=this.game.servers,r=this.game.clients,i=this.game.attackers,{x:o,y:n}=e;for(let e=0;e<s.length;e+=1){var c=s[e].position;if(Math.abs(o-c.x)<t&&Math.abs(n-c.y)<2*t)return!0}for(let e=0;e<r.length;e+=1){var h=r[e].position;if(Math.abs(o-h.x)<a&&Math.abs(n-h.y)<a)return!0}for(let e=0;e<i.length;e+=1){var l=i[e].position;if(Math.abs(o-l.x)<a&&Math.abs(n-l.y)<a)return!0}}findClosestServer(a){let s,r=this.canvas.width;return this.game.servers.forEach(e=>{var t=VectorMath.distance(a,e.position);t<r&&(r=t,s=e)}),s}getRandomPosition(e){var t=this.canvas.width,a=this.canvas.height;return this.getRandomPositionBounded({x:e,y:e},{x:t-e,y:a-e})}getRandomPositionBounded(e,t){let a,s;for(;a=MathHelper.randomInt(e.x,t.x),s=MathHelper.randomInt(e.y,t.y),this.checkCollisions({x:a,y:s}););return{x:a,y:s}}}class NewGame{orchestrator;upgrades;popularity;game;scheduler;fader;constructor(e,t,a,s,r,i){this.orchestrator=e,this.upgrades=t,this.popularity=a,this.game=s,this.scheduler=r,this.fader=i}execute(){this.orchestrator.reset(),this.upgrades.reset(),this.popularity.reset(),this.game.reset(),this.scheduler.reset(),this.fader.emptyQueues()}}class SimpleButton{position;width;height;text;color;onClick;constructor(e,t,a,s,r,i){this.position=e,this.width=t,this.height=a,this.text=s,this.color=r,this.onClick=i}draw(e,t){var a=e?Utilities.invertColor(this.color):this.color;t.drawRect({position:this.position,width:this.width,height:this.height,color:e?this.color:void 0,borderColor:this.color,borderWidth:2}),t.drawText({position:this.position,text:this.text,fontSize:15,align:"center",color:a})}}class Credits{canvas;clouds;buttons;id=Defaults.gameModes.CREDITS;constructor(e,t,a){this.canvas=e,this.clouds=t;t=e.width,e=e.height;this.buttons=[Utilities.defaultButton({x:t/2,y:e-60},"Back",()=>{a.switchMode(Defaults.gameModes.MENU)})]}getButtons(){return this.buttons}draw(){this.clouds.draw(),this.drawCredits(128,"An idea by:","Treestle","(treestle.com)"),this.drawCredits(258,"Designed and developed by:","Naccio","(naccio.net)"),this.drawCredits(388,"Music by:","Macspider","(soundcloud.com/macspider)")}update(){}drawCredits(e,t,a,s){this.drawRect(e),this.drawHeading(e-28,t),this.drawMainText(e,a),this.drawSubText(e+28,s)}drawRect(e){var t=this.canvas.width;this.canvas.drawRect({position:{x:t/2,y:e},width:t,height:100,color:Defaults.secondaryColorTransparent,borderColor:Defaults.primaryColorMutedTransparent})}drawHeading(e,t){this.drawText(e,t,20,Defaults.accentColor,"bold")}drawMainText(e,t){this.drawText(e,t,30,Defaults.primaryColor)}drawSubText(e,t){this.drawText(e,t,15,Defaults.primaryColorMuted)}drawText(e,t,a,s,r){var i=this.canvas.width;this.canvas.drawText({position:{x:i/2,y:e},text:t,fontSize:a,fontWeight:r,align:"center",color:s})}}class CursorTracker{game;canvas;ui;mousePosition;constructor(e,t,a){this.game=e,this.canvas=t,this.ui=a,this.mousePosition={x:0,y:0}}bind(){this.canvas.onmousedown=e=>this.mouseDownHandler(e),this.canvas.onmouseup=e=>this.mouseUpHandler(e),this.canvas.onclick=e=>this.clickHandler(e),this.canvas.onmousemove=e=>{this.mousePosition={x:e.clientX-this.canvas.offsetLeft,y:e.clientY-this.canvas.offsetTop}},this.canvas.ontouchstart=e=>this.touchHandler(e),this.canvas.ontouchmove=e=>this.touchHandler(e),this.canvas.ontouchend=e=>this.touchHandler(e),this.canvas.ontouchcancel=e=>this.touchHandler(e)}clickHandler(e){var t=this.canvas,a=e.pageX-t.offsetLeft;this.ui.click(a,e.pageY-t.offsetTop)}cursorPositionHandler(a,s){let r=this.game,e=Defaults.gameModes,i=Defaults.clientSize,o=Defaults.serverSize;r.currentGameMode!=e.GAME&&r.currentGameMode!=e.TUTORIAL||(void 0!==r.selectedClient&&r.servers.forEach(function(e){var t=e.position;a>t.x-o/2-5&&a<t.x+o/2+5&&s>t.y-o/2-5&&s<t.y+o/2+5&&(r.selectedClient.connectedTo=e)}),r.selectedClient=void 0,r.clients.forEach(e=>{var t=e.position;a>t.x-i/2-5&&a<t.x+i/2+5&&s>t.y-o/2-5&&s<t.y+o/2+5&&void 0===e.connectedTo&&(r.selectedClient=e,this.mousePosition={...t})}))}mouseDownHandler(e){var t=this.canvas,a=e.pageX-t.offsetLeft;this.cursorPositionHandler(a,e.pageY-t.offsetTop)}mouseUpHandler(e){let r=this.game,t=this.canvas,a=Defaults.gameModes,i=Defaults.serverSize;if(r.currentGameMode==a.GAME||r.currentGameMode==a.TUTORIAL){let a=e.pageX-t.offsetLeft,s=e.pageY-t.offsetTop;void 0!==r.selectedClient&&r.servers.forEach(function(e){var t=e.position;a>t.x-i/2-5&&a<t.x+i/2+5&&s>t.y-i/2-5&&s<t.y+i/2+5&&(r.selectedClient.connectedTo=e,r.selectedClient=void 0)})}}touchHandler(e){let r=this.game,t=this.canvas,a=e.targetTouches[0],s=a.pageX-t.offsetLeft,i=a.pageY-t.offsetTop;if(e.preventDefault(),"touchstart"==e.type)this.mousePosition={x:s,y:i},this.ui.click(s,i),this.cursorPositionHandler(s,i);else if("touchmove"==e.type)this.mousePosition={x:s,y:i};else if("touchend"==e.type&&void 0!==r.selectedClient){let a=this.mousePosition,e=r.selectedClient.position,s=Defaults.serverSize,t=Defaults.clientSize;r.servers.forEach(function(e){var t=e.position;a.x>t.x-s/2-5&&a.x<t.x+s/2+5&&a.y>t.y-s/2-5&&a.y<t.y+s/2+5&&(r.selectedClient.connectedTo=e)}),(a.x<e.x-t/2-5||a.x>e.x+t/2+5||a.y<e.y-t/2-5||a.y>e.y+t/2+5)&&(r.selectedClient=void 0)}}}class GameArea{canvas;game;orchestrator;popularityTracker;upgradesTracker;cursor;fader;constructor(e,t,a,s,r,i,o){this.canvas=e,this.game=t,this.orchestrator=a,this.popularityTracker=s,this.upgradesTracker=r,this.cursor=i,this.fader=o}draw(){var e=this.game.selectedClient?.position;void 0!==e&&(this.canvas.drawLine({from:e,to:this.cursor.mousePosition,color:Defaults.highlightColor,width:Defaults.highlightWidth}),this.canvas.drawCircle({position:e,radius:Defaults.clientSize/2+Defaults.highlightWidth,color:Defaults.highlightColor})),this.drawConnections(),this.drawMessages(),this.drawClients(),this.drawAttackers(),this.drawServers(),this.drawUI()}drawAttackers(){this.game.attackers.forEach(e=>this.drawAttacker(e))}drawClients(){this.game.clients.forEach(e=>this.drawClient(e))}drawConnections(){this.game.clients.forEach(e=>this.drawConnection(e,Defaults.clientConnectionColor)),this.game.attackers.forEach(e=>this.drawConnection(e,Defaults.attackerConnectionColor))}drawMessages(){this.orchestrator.messages.forEach(e=>this.drawMessage(e))}drawServers(){this.game.servers.forEach(e=>this.drawServer(e))}drawUI(){var t=this.canvas.width,a=this.canvas.height;if(this.fader.draw(),this.popularityTracker.draw(a-14),this.canvas.drawText({position:{x:t/2,y:a-14},text:"Press space to pause",fontSize:18,fontFamily:"sans-serif",align:"center",baseline:"alphabetic",color:Defaults.secondaryColorMuted}),0<this.upgradesTracker.upgradesAvailable){let e={position:{x:t/2,y:a-35},fontSize:20,rgbColor:{r:255,g:0,b:0},id:"upgrade",text:"- Upgrade available! -",life:400,alpha:0,delta:0};this.fader.addPermanentText(e)}var e=Math.max(0,60*Defaults.gameLength-this.game.elapsedTime),s=Math.floor(e/60),r=Math.floor(e-60*s);let i="",o=(s<10&&(i+="0"),i+=s+":",r<10&&(i+="0"),i+=r,Defaults.secondaryColor);e<=30&&(o=Defaults.dangerColorMuted),e<=10&&(o=Defaults.dangerColor),this.canvas.drawText({position:{x:t-10,y:a-14},text:i,fontSize:18,fontFamily:"sans-serif",align:"end",baseline:"alphabetic",color:o})}drawAttacker(e){var t=Defaults.clientSize,e=e.position;this.canvas.drawTriangle({position:e,base:2*t/Math.sqrt(3),height:t,color:Defaults.attackerColor,borderColor:Defaults.attackerBorderColor,borderWidth:2}),this.canvas.drawText({position:{x:e.x,y:e.y+8},text:"DoS",fontWeight:"bold",fontSize:9,fontFamily:"Arial",align:"center",color:Defaults.attackerTextColor})}drawClient(e){var t=Defaults.clientSize,a=Defaults.maxClientWaitTime,s=e.position,t={position:s,radius:t/2,color:Defaults.clientColor,borderColor:Defaults.clientBorderColor};void 0===e.connectedTo?(void 0===e.connectedTo&&e.life>a-2?this.canvas.drawCircle({...t,color:Defaults.dangerColor,borderColor:Defaults.dangerColorDark}):void 0===e.connectedTo&&e.life>a-3.5?this.canvas.drawCircle({...t,color:Defaults.dangerColorMuted,borderColor:Defaults.dangerColorMutedDark}):this.canvas.drawCircle(t),this.canvas.drawText({position:s,text:Math.round(a-e.life).toString(),fontWeight:"bold",fontSize:15,fontFamily:"Arial",align:"center",color:Defaults.clientTextColor})):this.canvas.drawCircle(t)}drawConnection(e,t){e.connectedTo&&this.canvas.drawLine({from:e.position,to:e.connectedTo.position,color:t})}drawMessage(e){let t,a;switch(e.status){case"queued":case"done":return;case"req":t=Defaults.messageReqColor,a=Defaults.messageReqBorderColor;break;case"ack":t=Defaults.messageAckColor,a=Defaults.messageAckBorderColor;break;case"nack":t=Defaults.messageNackColor,a=Defaults.messageNackBorderColor;break;default:throw"Invalid message status: "+e.status}this.canvas.drawCircle({position:e.position,radius:Defaults.messageSize/2,color:t,borderColor:a})}drawServer(e){Utilities.drawServer(e,{},this.canvas)}}class Game{canvas;game;scheduler;gameArea;fader;id=Defaults.gameModes.GAME;constructor(e,t,a,s,r){this.canvas=e,this.game=t,this.scheduler=a,this.gameArea=s,this.fader=r}getButtons(){return[]}draw(){this.canvas.clear(),this.gameArea.draw()}update(e){0===this.game.servers.length&&this.scheduler.createServer("c"),this.game.update(e),this.fader.update(e),this.scheduler.schedule(),Math.floor(this.game.elapsedTime/60)===Defaults.gameLength&&0===this.game.clients.length&&this.game.switchMode(Defaults.gameModes.GAME_OVER)}}class GameOver{canvas;clouds;game;orchestrator;popularity;color=Defaults.primaryColor;buttons;id=Defaults.gameModes.GAME_OVER;constructor(e,t,a,s,r,i){this.canvas=e,this.clouds=t,this.game=a,this.orchestrator=s,this.popularity=r;t=e.width,s=e.height;this.buttons=[Utilities.defaultButton({x:t/2,y:s-110},"Restart",()=>i.execute()),Utilities.defaultButton({x:t/2,y:s-60},"Menu",()=>a.switchMode(Defaults.gameModes.MENU))]}getButtons(){return this.buttons}draw(){var e=this.canvas.width,t=this.canvas.height;this.clouds.draw(),this.canvas.drawText({position:{x:e/2,y:100},text:"Game Over",fontSize:60,fontVariant:"small-caps",align:"center",color:Defaults.accentColor}),this.drawStat(t/2-80,"Successful connections",this.game.clientsServed),this.drawStat(t/2-55,"Dropped connections",this.game.droppedConnections),this.drawStat(t/2-30,"Failed connections",this.game.failedConnections),this.drawStat(t/2-5,"Average response time",Math.round(100*this.orchestrator.avgResponseTime)/100);this.canvas.drawText({position:{x:e/2+68,y:t/2+50},text:"Popularity:",fontSize:30,align:"end",color:this.color}),this.canvas.drawText({position:{x:e/2+75,y:t/2+50},text:this.popularity.popularity.toString(),fontSize:30,align:"start",color:this.color}),this.canvas.drawLine({from:{x:e/2-130,y:t/2+20},to:{x:e/2+130,y:t/2+20},color:Defaults.accentColor})}update(){}drawStat(e,t,a){this.drawStatTitle(e,t),this.drawStatValue(e,a)}drawStatTitle(e,t){var a=this.canvas.width/2+80;this.canvas.drawText({position:{x:a,y:e},text:t+":",fontSize:15,align:"end",color:this.color})}drawStatValue(e,t){var a=this.canvas.width/2+90;this.canvas.drawText({position:{x:a,y:e},text:t.toString(),fontSize:15,align:"start",color:this.color})}}class TutorialStep{texts;hasNext=!1;hasHome=!1;advance=!1;advanceOnSpace=!1;extraButtons=[];constructor(e){this.texts=e}setup(){}update(e){}draw(){}}class Tutorial{steps;canvas;gameArea;fader;game;orchestrator;nextButton;homeButton;currentStep;currentStepIndex;id=Defaults.gameModes.TUTORIAL;constructor(e,t,a,s,r,i){this.steps=e,this.canvas=t,this.gameArea=a,this.fader=s,this.game=r,this.orchestrator=i;a=t.width,s=t.height;this.currentStep=e[0],this.currentStepIndex=0,this.nextButton=Utilities.defaultButton({x:a/3,y:s-40},"Next",()=>this.advance()),this.homeButton=Utilities.defaultButton({x:2*a/3,y:s-40},"Exit tutorial",()=>r.switchMode(Defaults.gameModes.MENU)),this.currentStep.setup(),document.addEventListener("keypress",e=>this.listener(e))}getButtons(){var e=[...this.currentStep.extraButtons];return this.currentStep.hasNext&&e.push(this.nextButton),this.currentStep.hasHome&&e.push(this.homeButton),e}draw(){var t=this.canvas.width,e=this.canvas.height,a=this.currentStep.texts,s={width:t,height:80,color:Defaults.backgroundColor,borderColor:Defaults.backgroundBorderColor};this.canvas.clear(),this.gameArea.draw(),this.fader.draw(),this.canvas.drawRect({position:{x:t/2,y:40},...s});for(let e=0;e<a.length;e++){var r=a[e];this.canvas.drawText({position:{x:t/2,y:18+20*e},text:r,fontWeight:"bold",fontSize:18,align:"center",color:Defaults.primaryColor})}this.canvas.drawRect({position:{x:t/2,y:e-40},...s}),this.currentStep.draw()}update(e){this.currentStep.update(e),this.fader.update(e),this.currentStep.advance&&this.advance()}reset(){this.game.reset(),this.orchestrator.reset(),this.fader.emptyQueues(),this.currentStepIndex=0,this.currentStep=this.steps[0],this.currentStep.setup(),this.game.switchMode(Defaults.gameModes.TUTORIAL)}advance(){this.currentStepIndex+=1,this.currentStep=this.steps[this.currentStepIndex],this.currentStep.setup()}listener(e){" "===e.key&&this.currentStep.advanceOnSpace&&this.advance()}}class Menu{canvas;clouds;buttons;id=Defaults.gameModes.MENU;constructor(e,t,a,s,r,i){this.canvas=e,this.clouds=t;t=e.width,e=e.height;this.buttons=[Utilities.defaultButton({x:t/2,y:e/2},"Tutorial",()=>r.reset()),Utilities.defaultButton({x:t/2,y:e/2+60},"New Game",()=>i.execute()),Utilities.defaultButton({x:t/2,y:e/2+120},"Credits",()=>a.switchMode(Defaults.gameModes.CREDITS)),s.volumeButton]}getButtons(){return this.buttons}draw(){var e=this.canvas.width,t=Defaults.primaryColorTransparent;this.clouds.draw(),this.canvas.drawRect({position:{x:e/2,y:140},width:e,height:180,color:Defaults.secondaryColorTransparent,borderColor:Defaults.primaryColorMutedTransparent}),this.canvas.drawText({position:{x:e/2,y:110},text:"Load Balancing",fontVariant:"small-caps",fontWeight:"bold",fontSize:110,align:"center",color:t}),this.canvas.drawText({position:{x:e/2,y:185},text:"The Game",fontSize:45,align:"center",color:t}),this.canvas.drawLine({from:{x:120,y:160},to:{x:e-118,y:160},color:Defaults.accentColor,width:2})}update(){}}class UpgradeButton{position;text;width;height;constructor(e,t,a){this.position=e,this.text=t,this.width=100,this.height=100,a&&(this.onClick=a)}onClick(){}draw(e,t){t.drawRect({position:this.position,width:this.width,height:this.height,color:Defaults.secondaryColor,borderColor:e?Defaults.primaryColor:void 0,borderWidth:2}),this.drawIcon(t),e&&t.drawText({position:{x:t.width/2,y:t.height-50},text:this.text,fontSize:20,align:"center",color:Defaults.accentColor})}}class CapacityUpgradeButton extends UpgradeButton{constructor(e,t){super(e,"Scale off at one location",t)}drawIcon(e){var t=this.position,a=Defaults.serverSize,s=t.x+a/2-7,r=t.y+1,i=Defaults.accentColor;Utilities.drawServer(new Server(t),{...Defaults.serverDisabledDefaults,queueColor:Defaults.accentColorMuted,queueBorderColor:Defaults.accentColor},e),e.drawArrow({from:{x:s,y:r-a/2+2},to:{x:s,y:r-a/2-13},color:i,width:3})}}class ServerUpgradeButton extends UpgradeButton{constructor(e,t){super(e,"Buy new datacenter",t)}drawIcon(e){var t=this.position;e.drawText({position:{x:t.x-25,y:t.y},text:"+",fontSize:45,align:"center",color:Defaults.accentColor}),Utilities.drawServer(new Server({x:t.x+15,y:t.y}),{...Defaults.serverDisabledDefaults,borderColor:Defaults.accentColor},e)}}class SpeedUpgradeButton extends UpgradeButton{constructor(e,t){super(e,"Improve speed at one location",t)}drawIcon(e){var t=this.position,a=Defaults.serverSize,s=t.x-a/2+7,a=t.y+a/2-9,r=Defaults.accentColor;Utilities.drawServer(new Server(t),{...Defaults.serverDisabledDefaults,speedColor:Defaults.accentColorMuted,speedBorderColor:Defaults.accentColor},e),e.drawArrow({from:{x:s,y:a-6},to:{x:s,y:a-21},color:r,width:3})}}class Pause{canvas;clouds;game;upgradesTracker;buttons;upgradeButtons;id=Defaults.gameModes.PAUSE;constructor(e,t,a,s,r,i){this.canvas=e,this.clouds=t,this.game=a,this.upgradesTracker=s;t=e.width,s=this.canvas.height/2+150;this.buttons=[Utilities.defaultButton({x:t/2,y:150},"Continue",()=>a.switchMode(Defaults.gameModes.GAME)),Utilities.defaultButton({x:t/2,y:210},"New game",()=>i.execute()),Utilities.defaultButton({x:t/2,y:270},"Abandon",()=>a.switchMode(Defaults.gameModes.MENU)),r.volumeButton],this.upgradeButtons=[new ServerUpgradeButton({x:250,y:s},()=>this.selectUpgrade("server")),new CapacityUpgradeButton({x:t/2,y:s},()=>this.selectUpgrade("capacity")),new SpeedUpgradeButton({x:t-250,y:s},()=>this.selectUpgrade("speed"))]}getButtons(){return 0<this.upgradesTracker.upgradesAvailable?[...this.buttons,...this.upgradeButtons]:[...this.buttons]}draw(){var e=this.canvas.width,t=this.canvas.height,e=e/2;this.clouds.draw(),0<this.upgradesTracker.upgradesAvailable?this.canvas.drawText({position:{x:e,y:t/2+60},text:"Choose an upgrade:",fontSize:25,align:"center",color:Defaults.secondaryColor}):this.canvas.drawText({position:{x:e,y:t/2+60},text:"No upgrades available",fontSize:25,align:"center",color:Defaults.primaryColorMuted}),this.canvas.drawText({position:{x:e,y:60},text:"~ Paused ~",fontSize:50,align:"center",color:Defaults.accentColor})}update(){}selectUpgrade(e){this.upgradesTracker.selectedUpgrade=e,this.game.switchMode(Defaults.gameModes.UPGRADE)}}class ClientExplanation extends TutorialStep{canvas;clientFactory;constructor(e,t){super(["This is a CLIENT.","It wants to exchange data with your datacenter.","Your job will be to connect the clients to a datacenter."]),this.canvas=e,this.clientFactory=t,this.hasNext=!0,this.hasHome=!0}setup(){var e=this.canvas.width,t=this.canvas.height;this.clientFactory.create({x:3*e/4,y:t/2},1e4).life=-31}draw(){var e={x:3*this.canvas.width/4,y:this.canvas.height/2};Utilities.drawCircleHighlight(e,Defaults.clientSize+9,this.canvas),this.canvas.drawCircle({position:e,radius:Defaults.clientSize/2,color:"gray"})}}class TutorialHelper{static drawLegend(e,t){var a=e.width-120;e.drawCircle({position:{x:a,y:100},radius:3,color:Defaults.messageReqColor,borderColor:Defaults.messageReqBorderColor}),e.drawText({position:{x:2+a+3,y:100},fontSize:10,fontFamily:"sans-serif",text:": Request"}),e.drawCircle({position:{x:a,y:108},radius:3,color:Defaults.messageAckColor,borderColor:Defaults.messageAckBorderColor}),e.drawText({position:{x:2+a+3,y:108},fontSize:10,fontFamily:"sans-serif",text:": Response (+1)"}),t&&(e.drawCircle({position:{x:a,y:116},radius:3,color:Defaults.messageNackColor,borderColor:Defaults.messageNackBorderColor}),e.drawText({position:{x:2+a+3,y:116},fontSize:10,fontFamily:"sans-serif",text:": Datacenter busy (-1)"}))}}class ClientSuccessExplanation extends TutorialStep{canvas;game;orchestrator;popularityTracker;constructor(e,t,a,s){super(["Nice! You can see your datacenter's speed in the bottom left of it.","Now the clients can finish their data exchange without any more problems.","When a client is served successfully you will gain some more popularity."]),this.canvas=e,this.game=t,this.orchestrator=a,this.popularityTracker=s,this.hasHome=!0}setup(){this.game.clients[0].messagesToSend=2,this.game.clients[0].ACKsToReceive=2,this.game.clients[1].messagesToSend=6,this.game.clients[1].ACKsToReceive=6,this.game.clients[2].messagesToSend=10,this.game.clients[2].ACKsToReceive=10,this.orchestrator.messages.forEach(function(e){"ack"===e.status&&(e.receiver.ACKsToReceive+=1),"queued"!==e.status&&"req"!==e.status||(e.sender.ACKsToReceive+=1)})}update(e){0===this.game.clients.length&&(this.hasNext=!0),this.game.update(e)}draw(){var e=this.canvas.width,t=this.canvas.height,a=Defaults.serverSize,e={x:e/2-a/2+7,y:t/2+a/4};this.popularityTracker.draw(t-95),TutorialHelper.drawLegend(this.canvas,!0),Utilities.drawCircleHighlight(e,15,this.canvas)}}class ConnectionExplanation extends TutorialStep{game;constructor(e){super(["To create a connection, click on the client and then on the datacenter.","Be quick though! Clients don't like waiting!","Create a CONNECTION to continue."]),this.game=e,this.hasHome=!0}update(e){var t=this.game.clients[0];void 0!==t.connectedTo&&(this.advance=!0),t.life>=Defaults.maxClientWaitTime-1&&(this.texts=["Snap! You let too much time pass!","Normally this would be bad for you, but this time you'll get a little help.","Create a CONNECTION to continue."],t.life=-31),this.game.updateClients(e)}}class ConnectMoreClients extends TutorialStep{canvas;game;popularityTracker;clientFactory;constructor(e,t,a,s){super(["Cool! Two new clients want to use your service!","Connect them as well to start gaining some more popularity.","Remember, if you wait too much, you will lose popularity!"]),this.canvas=e,this.game=t,this.popularityTracker=a,this.clientFactory=s,this.hasHome=!0}setup(){this.spawnClients()}update(e){var t=this.game.servers[0];t.queue.length>t.capacity/2&&(this.advance=!0),1===this.game.clients.length&&(this.texts=["Oh snap! You let too much time pass!","As you can see you lost 10 popularity each.","Connect the two clients to continue."],this.spawnClients()),this.game.update(e)}draw(){var e=this.canvas.height;this.popularityTracker.draw(e-95),TutorialHelper.drawLegend(this.canvas,!1)}spawnClients(){var e=this.canvas.width,t=this.canvas.height,a=this.clientFactory.create({x:e/4,y:t/4},1e4),e=this.clientFactory.create({x:e/4,y:3*t/4},1e4);a.life=-21,e.life=-21}}class ConnectToNewServer extends TutorialStep{canvas;game;popularityTracker;clientFactory;constructor(e,t,a,s){super(["Perfect! Now you have a new datacenter at your disposal.","This is when a good load balancing strategy will start to matter.","Indeed you would be wiser to connect the clients to the new datacenter."]),this.canvas=e,this.game=t,this.popularityTracker=a,this.clientFactory=s,this.hasHome=!0}setup(){this.game.clients[0].life=-21,this.game.clients[1].life=-21}update(e){var t,a,s;0===this.game.clients.length&&(s=this.canvas.width,t=this.canvas.height,a=this.clientFactory.create({x:s/4,y:t/3},1e4),s=this.clientFactory.create({x:3*s/4,y:t/3},1e4),a.life=-21,s.life=-21),void 0!==this.game.clients[0].connectedTo&&void 0!==this.game.clients[1].connectedTo&&(this.advance=!0),this.game.update(e)}draw(){var e=this.canvas.height;this.popularityTracker.draw(e-95),TutorialHelper.drawLegend(this.canvas,!0)}}class DdosAttackExample extends TutorialStep{canvas;game;fader;clientFactory;attackerFactory;constructor(e,t,a,s,r){super(["Oh snap! Your datacenter is under a DDOS ATTACK! And more clients need serving!","This is likely to happen as you get more and more popular.","You'd better upgrade once again to cope with this situation."]),this.canvas=e,this.game=t,this.fader=a,this.clientFactory=s,this.attackerFactory=r,this.hasHome=!0,this.advanceOnSpace=!0}setup(){var e=this.canvas.width,t=this.canvas.height,a=this.game.servers[0],s={position:{x:e/2,y:t-116},fontSize:20,rgbColor:{r:255,g:0,b:0},id:"upgradeTut",text:"- Upgrade available! -",life:1e3,alpha:0,delta:0};this.attackerFactory.create({x:e/2,y:3*t/4},1e4,a),this.attackerFactory.create({x:e/3,y:2*t/3},1e4,a),this.attackerFactory.create({x:2*e/3,y:2*t/3},1e4,a),this.spawnClients(),this.fader.addPermanentText(s)}update(e){this.game.selectedClient&&(this.game.selectedClient=void 0),0===this.game.clients.length&&this.spawnClients(),this.game.update(e)}draw(){var e=this.canvas.width,t=this.canvas.height;TutorialHelper.drawLegend(this.canvas,!0),this.canvas.drawText({position:{x:e/2,y:t-95},text:"Press space to pause",fontSize:18,fontFamily:"sans-serif",align:"center",color:Defaults.secondaryColorMuted})}spawnClients(){var e=this.canvas.width,t=this.canvas.height,a=this.clientFactory.create({x:e/4,y:t/3},1e4),e=this.clientFactory.create({x:3*e/4,y:t/3},1e4);a.life=-21,e.life=-21}}class NewServerUpgradeExample extends TutorialStep{canvas;fader;constructor(e,t,a){super(["This time let's buy a new datacenter.","This way you can connect the clients to it while your first one is under attack.","Select the first upgrade (Buy new datacenter)."]),this.canvas=e,this.fader=a;let s=e.width,r=e.height,i=r/2+150;this.extraButtons=[new ServerUpgradeButton({x:250,y:i},()=>{t.create({x:s/2,y:r/4}).capacity=20,this.advance=!0}),new CapacityUpgradeButton({x:s/2,y:i}),new SpeedUpgradeButton({x:s-250,y:i})]}setup(){this.fader.removeFromPermanentQueue("upgradeTut")}draw(){var e=this.canvas.width,t=this.canvas.height;this.canvas.drawRect({position:this.canvas.center,width:e,height:t-158,color:Defaults.backgroundColor}),this.canvas.drawText({position:{x:e/2,y:t/2+60},text:"Choose an upgrade:",fontSize:25,align:"center"}),this.canvas.drawText({position:{x:e/2,y:t/3},text:"~ Paused ~",fontSize:50,align:"center",color:Defaults.accentColor})}}class PopularityExplanation extends TutorialStep{canvas;game;popularityTracker;constructor(e,t,a){super(["Good job! Now your very first client is being served.","You can see the REQUESTS and RESPONSES traveling along the connection.","The POPULARITY measures how successful your service is being."]),this.canvas=e,this.game=t,this.popularityTracker=a,this.hasNext=!0,this.hasHome=!0}setup(){this.popularityTracker.popularity=0}update(e){this.game.update(e)}draw(){var e=this.canvas.height,t={x:70,y:e-95};this.popularityTracker.draw(e-95),TutorialHelper.drawLegend(this.canvas,!1),Utilities.drawCircleHighlight(t,67,this.canvas)}}class ServerBusyExample extends TutorialStep{canvas;game;popularityTracker;constructor(e,t,a){super(["Oh no! Looks like your datacenter can't handle all this traffic!","Clients will not be pleased if your datacenter is too busy to reply.","You can see how busy a datacenter is by looking at its status bar."]),this.canvas=e,this.game=t,this.popularityTracker=a,this.hasNext=!0,this.hasHome=!0}update(e){this.game.update(e)}draw(){var e=this.canvas.width,t=this.canvas.height,a=Defaults.serverSize,e={x:e/2+a/2-7,y:t/2+1};this.popularityTracker.draw(t-95),TutorialHelper.drawLegend(this.canvas,!0),Utilities.drawCircleHighlight(e,a/2,this.canvas)}}class ServerExplanation extends TutorialStep{canvas;constructor(e){super(["This is a DATACENTER.","Its role is to send data to your clients.",'Click "Next" to continue.']),this.canvas=e,this.hasNext=!0,this.hasHome=!0}draw(){Utilities.drawCircleHighlight(this.canvas.center,Defaults.serverSize+9,this.canvas)}}class SpeedUpgradeExample extends TutorialStep{canvas;game;fader;constructor(e,t,a){super(["Let's improve your datacenter's speed.","This way it will process the clients' requests faster.","Select the third upgrade (Improve speed at one location)."]),this.canvas=e,this.game=t,this.fader=a;t=e.width,a=e.height/2+150;this.extraButtons=[new ServerUpgradeButton({x:250,y:a}),new CapacityUpgradeButton({x:t/2,y:a}),new SpeedUpgradeButton({x:t-250,y:a},()=>{this.game.servers[0].speed+=Defaults.serverSpeed,this.advance=!0})]}setup(){this.fader.removeFromPermanentQueue("upgradeTut")}draw(){var e=this.canvas.width,t=this.canvas.height;this.canvas.drawRect({position:this.canvas.center,width:e,height:t-158,color:Defaults.backgroundColor}),this.canvas.drawText({position:{x:e/2,y:t/2+60},text:"Choose an upgrade:",fontSize:25,align:"center"}),this.canvas.drawText({position:{x:e/2,y:t/3},text:"~ Paused ~",fontSize:50,align:"center",color:Defaults.accentColor})}}class TutorialFinished extends TutorialStep{canvas;game;popularityTracker;constructor(e,t,a,s){super(["Excellent! By now you should know all the basics.","This tutorial is finished.","You can start a new game or go back to the main menu."]),this.canvas=e,this.game=t,this.popularityTracker=a;t=e.width,a=e.height;this.hasHome=!0,this.extraButtons=[Utilities.defaultButton({x:t/3,y:a-40},"New game",()=>s.execute())]}update(e){this.game.update(e)}draw(){var e=this.canvas.height;this.popularityTracker.draw(e-95),TutorialHelper.drawLegend(this.canvas,!0)}}class UpgradesIntroduction extends TutorialStep{canvas;game;popularityTracker;fader;constructor(e,t,a,s){super(["Thankfully, you are popular enough to afford to UPGRADE your datacenter.","As your popularity grows, you will be able to upgrade it even more.","Press SPACE to pause the game and select an upgrade."]),this.canvas=e,this.game=t,this.popularityTracker=a,this.fader=s,this.hasHome=!0,this.advanceOnSpace=!0}setup(){var e=this.canvas.width,t=this.canvas.height;this.fader.addPermanentText({position:{x:e/2,y:t-116},fontSize:20,rgbColor:{r:255,g:0,b:0},id:"upgradeTut",text:"- Upgrade available! -",life:1e3,alpha:0,delta:0})}update(e){this.game.update(e)}draw(){var e=this.canvas.width,t=this.canvas.height;this.popularityTracker.draw(t-95),TutorialHelper.drawLegend(this.canvas,!0),this.canvas.drawText({position:{x:e/2,y:t-95},text:"Press space to pause",fontSize:18,fontFamily:"sans-serif",align:"center",color:Defaults.secondaryColorMuted})}}class Welcome extends TutorialStep{canvas;serverFactory;constructor(e,t){super(["Welcome to Load Balancing: The Game!","Here you will take the role of -you guessed it- a LOAD BALANCER.",'Click "Next" to start the tutorial.']),this.canvas=e,this.serverFactory=t,this.hasNext=!0,this.hasHome=!0}setup(){this.serverFactory.create(this.canvas.center).capacity=20}}class BorderButton{position;width;height;color;hoverColor;borderWidth;onClick;constructor(e,t,a,s,r,i,o){this.position=e,this.width=t,this.height=a,this.color=s,this.hoverColor=r,this.borderWidth=i,this.onClick=o}draw(e,t){e=e?this.hoverColor:this.color;t.drawRect({position:this.position,width:this.width,height:this.height,borderColor:e,borderWidth:this.borderWidth})}}class Upgrade{canvas;game;upgradesTracker;scheduler;gameArea;fader;id=Defaults.gameModes.UPGRADE;constructor(e,t,a,s,r,i){this.canvas=e,this.game=t,this.upgradesTracker=a,this.scheduler=s,this.gameArea=r,this.fader=i}getButtons(){var e=this.canvas.width,t=this.canvas.height,a=Utilities.defaultButton({x:e/2,y:t-100},"Cancel",()=>this.game.switchMode(Defaults.gameModes.PAUSE));a.color=Defaults.secondaryColor;let s=[a];switch(this.upgradesTracker.selectedUpgrade){case"speed":s=[...s,...this.createServerButtons(e=>e.speed+=2)];break;case"capacity":s=[...s,...this.createServerButtons(e=>e.capacity+=Defaults.serverCapacity)];break;case"server":s=[...s,this.createAreaButton(Math.floor(e/6),Math.floor(t/6),"nw"),this.createAreaButton(Math.floor(e/2),Math.floor(t/6),"n"),this.createAreaButton(Math.floor(5*e/6)+1,Math.floor(t/6),"ne"),this.createAreaButton(Math.floor(e/6),Math.floor(t/2),"w"),this.createAreaButton(Math.floor(e/2),Math.floor(t/2),"c"),this.createAreaButton(Math.floor(5*e/6)+1,Math.floor(t/2),"e"),this.createAreaButton(Math.floor(e/6),Math.floor(5*t/6),"sw"),this.createAreaButton(Math.floor(e/2),Math.floor(5*t/6),"s"),this.createAreaButton(Math.floor(5*e/6)+1,Math.floor(5*t/6),"se")]}return s}draw(){var e=this.canvas.width;this.canvas.clear(),this.gameArea.drawServers();let t;switch(this.upgradesTracker.selectedUpgrade){case"speed":case"capacity":t="location";break;case"server":t="zone"}this.canvas.drawText({position:{x:e/2,y:60},text:`~ Select ${t} ~`,fontSize:30,align:"center",color:Defaults.accentColor})}update(){}createAreaButton(e,t,a){var s=this.canvas.width,r=this.canvas.height,i=Defaults.highlightWidth;return new BorderButton({x:e,y:t},Math.floor(s/3)-i,Math.floor(r/3)-i,"transparent",Defaults.highlightColor,i,()=>{this.scheduler.createServer(a),this.selectUpgrade()})}createServerButton(e,t){var a=Defaults.highlightWidth,s=Defaults.serverSize+a;return new BorderButton(e.position,s,s,"transparent",Defaults.highlightColor,a,()=>{t(),this.selectUpgrade()})}createServerButtons(t){return this.game.servers.map(e=>this.createServerButton(e,()=>t(e)))}selectUpgrade(){this.upgradesTracker.selectedUpgrade=void 0,--this.upgradesTracker.upgradesAvailable,this.fader.removeFromPermanentQueue("upgrade"),this.game.switchMode(Defaults.gameModes.PAUSE)}}class FpsCounter{lastTimestamp=Date.now();fps=0;update(){var e=Date.now(),t=(e-this.lastTimestamp)/1e3;this.fps=Math.floor(1/t),this.lastTimestamp=e}logFps(){let e=document.getElementById("fps");var t;e||((t=document.getElementById("log"))&&(t.innerHTML='Fps: <span id="fps"></span><br />'+t.innerHTML),e=document.getElementById("fps")),e.innerHTML=this.fps.toString()}}class Application{scenes;game;ui;cursor;canvas;fpsCounter;clouds;activeScene;logActive=!1;constructor(e,t,a,s,r,i,o){this.scenes=e,this.game=t,this.ui=a,this.cursor=s,this.canvas=r,this.fpsCounter=i,this.clouds=o;t=r.width,a=r.height;this.activeScene=e[0],o.setSkyColor(Defaults.backgroundColor),this.createCloud(t/4,a/4),this.createCloud(0-t/4,a/3),this.createCloud(t/2,a/2),this.createCloud(0-t/2,3*a/4),this.createCloud(3*t/4,2*a/3),this.createCloud(0-3*t/4,a/2),document.addEventListener("keypress",e=>this.keyboardHandler(e)),window.addEventListener("blur",()=>this.blurHandler())}static build(e){var t=document.getElementById("canvas"),a=new Audio("assets/music.mp3"),s=new Canvas(t),r=new TextFader(s),i=new FpsCounter,o=new MessageOrchestrator,n=new UpgradesTracker,c=new PopularityTracker(r,n,s),h=new GameUI(a,s),l=new GameTracker(c,h,o),d=new AttackerFactory(l,o),u=new ClientFactory(l,o,c),p=new ServerFactory(l),t=new CursorTracker(l,t,h),g=new Scheduler(c,s,l,u,d,p),v=new GameArea(s,l,o,c,n,t,r),m=new NewGame(o,n,c,l,g,r),f=new Credits(s,e,l),y=new GameOver(s,e,l,o,c,m),w=new Pause(s,e,l,n,h,m),n=new Upgrade(s,l,n,g,v,r),g=new Game(s,l,g,v,r),d=new Tutorial([new Welcome(s,p),new ServerExplanation(s),new ClientExplanation(s,u),new ConnectionExplanation(l),new PopularityExplanation(s,l,c),new ConnectMoreClients(s,l,c,u),new ServerBusyExample(s,l,c),new UpgradesIntroduction(s,l,c,r),new SpeedUpgradeExample(s,l,r),new ClientSuccessExplanation(s,l,o,c),new DdosAttackExample(s,l,r,u,d),new NewServerUpgradeExample(s,p,r),new ConnectToNewServer(s,l,c,u),new TutorialFinished(s,l,c,m)],s,v,r,l,o),p=new Menu(s,e,l,h,d,m);return t.bind(),a.loop=!0,new Application([p,g,y,f,w,n,d],l,h,t,s,i,e)}run(){let e=1e3/Defaults.frameRate;setInterval(()=>this.mainLoop(e),e)}mainLoop(e){this.activeScene.id!==this.game.currentGameMode&&(this.activeScene=this.scenes.find(e=>e.id===this.game.currentGameMode)),this.clouds.update(e),this.activeScene.update(e),this.activeScene.draw(),this.ui.buttons=this.activeScene.getButtons(),this.drawButtons(),this.logActive&&(this.fpsCounter.update(),this.fpsCounter.logFps())}createCloud(e,t){var a=MathHelper.random(350,500),s=MathHelper.random(a,700),r=MathHelper.random(15,30),i=MathHelper.random(180,255),i={r:i,g:i,b:i,a:.1},o=MathHelper.random(100,200);this.clouds.add(e,t,a,s,r,i,o)}drawButtons(){let a=this.cursor.mousePosition;this.ui.buttons.forEach(e=>{var t=e.position,t=a.x>t.x-(e.width+2)/2&&a.x<t.x+(e.width+2)/2&&a.y>t.y-(e.height+4)/2&&a.y<t.y+(e.height+2)/2;e.draw(t,this.canvas)})}blurHandler(){this.game.currentGameMode===Defaults.gameModes.GAME&&this.game.switchMode(Defaults.gameModes.PAUSE)}keyboardHandler(e){e.preventDefault()," "===e.key&&((e=this.game).currentGameMode===Defaults.gameModes.GAME?e.switchMode(Defaults.gameModes.PAUSE):e.currentGameMode===Defaults.gameModes.PAUSE&&e.switchMode(Defaults.gameModes.GAME))}}class VectorCalculator{v;constructor(e){this.v=e}get x(){return this.v.x}get y(){return this.v.y}add(e){return VectorMath.add(this,e)}angle(e){return VectorMath.angle(this,e)}clamp(e,t){return VectorMath.clamp(this,e,t)}direction(e){return VectorMath.direction(this,e)}divide(e){return VectorMath.divide(this,e)}dotProduct(e){return VectorMath.dotProduct(this,e)}invert(){return VectorMath.invert(this)}isEqual(e){return VectorMath.isEqual(this,e)}magnitude(){return VectorMath.magnitude(this)}multiply(e){return VectorMath.multiply(this,e)}normalize(){return VectorMath.normalize(this)}rotate(e){return VectorMath.rotate(this,e)}round(e){return VectorMath.round(this,e)}subtract(e){return VectorMath.subtract(this,e)}}